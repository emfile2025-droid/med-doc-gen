<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<meta name="description" content="AI Medical Document Generator v4.12">
<meta name="theme-color" content="#005088">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Med-Doc">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">

<title>Med-Doc Gen v4.12</title>
<style>
  /* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
  :root {
    --primary: #005088;
    --primary-dark: #003f6b;
    --accent: #d35400;
    --bg: #f2f4f8;
    --surface: #ffffff;
    --text: #1a1a1a;
    --border: #ced4da;
    --success: #27ae60;
    --warning: #f39c12;
    --danger: #e74c3c;
    --sa-top: env(safe-area-inset-top, 20px);
    --sa-bottom: env(safe-area-inset-bottom, 20px);
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    margin: 0; padding: 0;
    background-color: var(--bg); color: var(--text);
    font-family: "Hiragino Sans", "Hiragino Kaku Gothic ProN", -apple-system, BlinkMacSystemFont, sans-serif;
    padding-top: calc(var(--sa-top) + 10px);
    padding-bottom: calc(var(--sa-bottom) + 30px);
    font-size: 15px;
    overscroll-behavior-y: none; 
  }
  .container {
    width: 100%; max-width: 600px; margin: 0 auto; padding: 0 16px;
    display: flex; flex-direction: column; gap: 16px;
  }

  /* --- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ --- */
  #toastContainer {
    position: fixed; top: calc(var(--sa-top) + 16px); left: 50%; transform: translateX(-50%);
    z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none;
  }
  .toast {
    padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2); pointer-events: auto; max-width: 90vw; text-align: center;
    animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
  }
  .toast.success { background: var(--success); }
  .toast.error { background: var(--danger); }
  .toast.warning { background: var(--warning); }
  .toast.info { background: var(--primary); }
  @keyframes toastIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

  /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
  header { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
  h1 { font-size: 18px; font-weight: 800; color: var(--primary); margin: 0; display: flex; align-items: center; gap: 8px; }
  .badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: 700; background: #e3f2fd; color: #0277bd; border: 1px solid #b3e5fc; }
  button.btn-settings { font-size: 22px; background: none; border: none; padding: 4px; cursor: pointer; opacity: 0.6; }

  /* --- è¨­å®šã‚¨ãƒªã‚¢ --- */
  #settingsOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; }
  #settingsArea {
    background: #fff; border: 1px solid var(--border); padding: 20px; 
    border-radius: 12px; display: none; flex-direction: column; gap: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1); z-index: 100;
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 90%; max-width: 400px;
  }
  .setting-group { display: flex; flex-direction: column; gap: 6px; }
  .setting-label { font-size: 13px; font-weight: 700; color: #444; }
  .setting-input { padding: 12px; border: 1px solid #bbb; border-radius: 8px; font-size: 15px; background: #f9f9f9; }
  select.setting-input { background-color: #fff; }

  /* --- ã‚¿ãƒ– --- */
  .tabs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #e9ecef; padding: 6px; border-radius: 12px; }
  .tab {
    padding: 10px; font-size: 13px; font-weight: 700; 
    border-radius: 8px; border: none; background: transparent; 
    color: #6c757d; transition: all 0.2s; cursor: pointer;
  }
  .tab.active { background: #fff; color: var(--primary); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }

  /* --- ã‚«ãƒ¼ãƒ‰ --- */
  .card {
    background: var(--surface); border-radius: 12px; padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 12px;
  }
  .label-row { display: flex; justify-content: space-between; align-items: center; }
  label { font-weight: 700; font-size: 13px; color: #555; display: flex; align-items: center; gap: 6px; }

  /* --- å›ºå®šå…¥åŠ›æ  --- */
  /* display: none ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‚JavaScriptã§ display: grid ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ */
  .field-grid { display: none; grid-template-columns: 1fr 1fr; gap: 10px; }
  .field-full { grid-column: 1 / -1; }
  .input-field {
    width: 100%; padding: 10px; border: 1px solid #bbb; border-radius: 8px;
    font-size: 14px; background: #fdfdfd;
  }
  .input-field:focus { border-color: var(--primary); outline: none; background: #fff; }
  .field-label { font-size: 11px; font-weight: bold; color: #666; margin-bottom: 4px; display: block; }

  /* --- ã‚«ãƒ¡ãƒ© --- */
  .btn-camera {
    width: 100%; padding: 14px; 
    border: 2px dashed #aab7c4; border-radius: 10px;
    background: #f8fbff; color: var(--primary); 
    font-size: 14px; font-weight: 700;
    display: flex; justify-content: center; align-items: center; gap: 8px;
    cursor: pointer;
  }
  .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px; }
  .thumb-container { position: relative; width: 100%; padding-top: 100%; border-radius: 8px; overflow: hidden; background: #eee; }
  .thumb-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
  .btn-remove-thumb {
    position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: #fff; border: none;
    border-radius: 50%; width: 20px; height: 20px; font-size: 12px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }

  /* --- ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ --- */
  textarea {
    width: 100%; border: 1px solid var(--border); border-radius: 10px; padding: 12px;
    font-size: 16px; line-height: 1.6; resize: none; background: #fff;
    font-family: inherit; -webkit-appearance: none;
  }
  textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
  #inputText { min-height: 100px; }
  #outputText { min-height: 350px; background: #fcfcfc; border-color: #d1d9e6; color: #212529; font-family: "Hiragino Sans", sans-serif; }

  /* --- ãƒœã‚¿ãƒ³ --- */
  .btn-main {
    width: 100%; padding: 16px; border: none; border-radius: 10px;
    font-size: 16px; font-weight: 700; cursor: pointer;
    display: flex; justify-content: center; align-items: center; gap: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: opacity 0.2s;
  }
  .btn-main:active { opacity: 0.8; }
  .btn-generate { background: var(--primary); color: #fff; }
  .btn-generate:disabled { background: #95a5a6; cursor: not-allowed; }
  .btn-clear-imgs { font-size:12px; color:#c0392b; background:none; border:none; text-decoration:underline; cursor:pointer; }
  .btn-continue { background: #f39c12; color: #fff; margin-top: 10px; display: none; }
  .btn-copy { background: #27ae60; color: #fff; margin-top: 10px; }
  
  .hint { font-size: 12px; color: #555; background: linear-gradient(135deg, #e8f4fd 0%, #f0f7ff 100%); padding: 10px 14px; border-radius: 8px; line-height: 1.5; border-left: 3px solid var(--primary); }
  .hint strong { color: var(--primary); }
  
  .spinner { width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #cameraInput { display: none; }
</style>
</head>
<body>

<div id="toastContainer"></div>

<div class="container">
  
  <header>
    <h1>Med-Doc <span style="font-size:0.8em; opacity:0.6;">Pro</span>
      <span class="badge" id="modelBadge">Loading...</span>
    </h1>
    <button class="btn-settings" onclick="toggleSettings()">âš™ï¸</button>
  </header>

  <div id="settingsOverlay" onclick="toggleSettings()"></div>
  <div id="settingsArea">
    <div style="text-align:center; font-weight:bold; margin-bottom:10px;">è¨­å®š</div>
    <div class="setting-group">
      <div class="setting-label">Gemini API Key</div>
      <input type="password" id="apiKeyInput" class="setting-input" placeholder="AIzaSy..." onchange="saveApiKey()">
    </div>
    <div class="setting-group">
      <div class="setting-label">ä½¿ç”¨AIãƒ¢ãƒ‡ãƒ«</div>
      <select id="modelSelect" class="setting-input" onchange="changeModel()">
        <option value="gemini-2.5-pro">Gemini 2.5 Pro (ç´„Â¥8/å›) â˜…æ¨å¥¨</option>
        <option value="gemini-2.5-flash">Gemini 2.5 Flash (ç´„Â¥2/å›) é«˜é€Ÿ</option>
        <option value="gemini-3-pro-preview">Gemini 3 Pro (ç´„Â¥11/å›)</option>
        <option value="gemini-3-flash-preview">Gemini 3 Flash (ç´„Â¥3/å›)</option>
        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ ...</option>
      </select>
      <input type="text" id="customModelInput" class="setting-input" style="display:none; margin-top:6px;" placeholder="gemini-experimental">
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; gap:10px;">
      <button onclick="window.location.reload(true)" style="background:#666; font-size:0.8rem; padding:5px 10px; border:none; color:#fff; border-radius:6px; cursor:pointer;">ã‚¢ãƒ—ãƒªã‚’æ›´æ–°</button>
      <button onclick="toggleSettings()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px; font-weight:bold;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="setMode('summary')" id="tabSummary">é€€é™¢ã‚µãƒãƒªãƒ¼</button>
    <button class="tab" onclick="setMode('shoki')" id="tabShoki">ç—‡çŠ¶è©³è¨˜</button>
    <button class="tab" onclick="setMode('summary-shoki')" id="tabSummaryShoki">ã‚µãƒãƒªãƒ¼ï¼†è©³è¨˜</button>
    <button class="tab" onclick="setMode('letter')" id="tabLetter">ç´¹ä»‹çŠ¶</button>
    <button class="tab" onclick="setMode('consult')" id="tabConsult">ã‚³ãƒ³ã‚µãƒ«ãƒˆ</button>
  </div>

  <div class="card">
    
    <div id="consultFields" class="field-grid">
      <div><span class="field-label">å®›å…ˆè¨ºç™‚ç§‘</span><select id="targetDept" class="input-field">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      </select></div>
      <div><span class="field-label">ä¾é ¼ç›®çš„</span><select id="consultPurpose" class="input-field">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="è»¢ç§‘ä¾é ¼">è»¢ç§‘ä¾é ¼</option>
        <option value="ä½µè¨ºä¾é ¼">ä½µè¨ºä¾é ¼</option>
        <option value="å°‚é–€è¨ºå¯ŸãŠã‚ˆã³å¾¡åŠ©è¨€ä¾é ¼">å°‚é–€è¨ºå¯ŸãŠã‚ˆã³å¾¡åŠ©è¨€ä¾é ¼</option>
        <option value="#7000ç•ªç´¹ä»‹ä¾é ¼">#7000ç•ªç´¹ä»‹ä¾é ¼</option>
      </select></div>
    </div>
    <div id="letterFields" class="field-grid">
      <div class="field-full"><span class="field-label">å®›å…ˆåŒ»ç™‚æ©Ÿé–¢</span><input type="text" id="targetHospital" class="input-field" placeholder="ä¾‹: â—‹â—‹ã‚¯ãƒªãƒ‹ãƒƒã‚¯ / â–³â–³ç—…é™¢ â–¡â–¡ç§‘"></div>
      <div class="field-full"><span class="field-label">ç´¹ä»‹ç›®çš„</span><select id="letterPurpose" class="input-field">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="è»¢é™¢">è»¢é™¢</option>
        <option value="å¤–æ¥åŠ ç™‚ä¾é ¼">å¤–æ¥åŠ ç™‚ä¾é ¼</option>
        <option value="å…¥é™¢çµŒéå ±å‘Š">å…¥é™¢çµŒéå ±å‘Š</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select></div>
    </div>
    <div id="sourceFields" class="field-grid" style="margin-top:0;">
      <div><span class="field-label">ç´¹ä»‹å…ƒ(è‡ªç§‘) â€»ä¿å­˜</span><input type="text" id="sourceDept" class="input-field" placeholder="ä¾‹: æ•‘æ€¥ç§‘" onchange="saveProfile()"></div>
      <div><span class="field-label">ç´¹ä»‹è€…(è‡ªåˆ†) â€»ä¿å­˜</span><input type="text" id="referrerName" class="input-field" placeholder="ä¾‹: æ•‘æ€¥å¤ªéƒ" onchange="saveProfile()"></div>
    </div>
    
    <hr style="width:100%; border:0; border-top:1px dashed #ddd; margin:12px 0;">

    <div class="label-row">
       <div class="btn-camera" onclick="document.getElementById('cameraInput').click()"><span>ğŸ“· çµŒé/ç”»åƒ (è¤‡æ•°å¯)</span></div>
       <button class="btn-clear-imgs" onclick="clearImages()">å…¨å‰Šé™¤</button>
    </div>
    <input type="file" id="cameraInput" accept="image/*" multiple onchange="handleImageSelect(this)">
    <div class="image-grid" id="imageGrid"></div>

    <div class="hint" id="modeHint"></div>
    <textarea id="inputText"></textarea>

    <button class="btn-main btn-generate" id="generateBtn" onclick="generateDoc()">
      <span id="btnContent">âœ¨ ç”Ÿæˆé–‹å§‹</span>
    </button>
  </div>

  <div class="card">
    <div class="label-row"><label>iNoteè²¼ä»˜ç”¨</label><span style="font-size:10px; color:#999;" id="statusText"></span></div>
    <textarea id="outputText" readonly placeholder="ã“ã“ã«ç”ŸæˆçµæœãŒå‡ºã¾ã™"></textarea>
    <button class="btn-main btn-continue" id="continueBtn" onclick="generateContinue()">ğŸ”„ ç¶šãã‚’æ›¸ã</button>
    <button class="btn-main btn-copy" onclick="copyToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼ (iNoteã¸)</button>
  </div>
  
  <div style="text-align:center; font-size:10px; color:#aaa; margin-top:20px;">Med-Doc Gen v4.12</div>
</div>

<script>
  /* --- Global State --- */
  let currentMode = 'summary';
  let apiKey = localStorage.getItem('med_gen_api_key_v3') || '';
  let currentModel = localStorage.getItem('med_gen_model') || 'gemini-2.5-pro'; 
  let currentImages = [];
  let lastContentsParts = null;

  /* --- è²»ç”¨è¨ˆç®—ï¼ˆ2500å­—ã®æ—¥æœ¬èªã‚’å‡¦ç†ã—ãŸå ´åˆï¼‰ --- */
  // æ—¥æœ¬èª2500å­—ã‚’ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã«æ›ç®—ï¼ˆ1æ–‡å­—â‰ˆ1.5ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ»ç”»åƒã‚’å«ã‚ã¦æ¦‚ç®—ï¼‰
  // å…¥åŠ›: ç´„5000ãƒˆãƒ¼ã‚¯ãƒ³ã€å‡ºåŠ›: ç´„5000ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ2500å­—ã®å›ç­”ã¨ä»®å®šï¼‰ã¨ã—ã¦è¨ˆç®—
  function getModelCostEstimate(modelName) {
    const INPUT_TOKENS = 5000;  // 2500å­— + ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ + ç”»åƒãªã©ã®æ¦‚ç®—
    const OUTPUT_TOKENS = 5000; // 2500å­—ã®å›ç­”ã¨ä»®å®š
    const TOKENS_PER_MILLION = 1000000;
    
    // 1ãƒ‰ãƒ« = 150å††ã§æ›ç®—
    const USD_TO_JPY = 150;
    
    let inputCost = 0;
    let outputCost = 0;
    
    if (modelName === 'gemini-3-pro-preview') {
      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ <= 200,000 ãƒˆãƒ¼ã‚¯ãƒ³ã®å ´åˆ
      inputCost = (INPUT_TOKENS / TOKENS_PER_MILLION) * 2.00;
      outputCost = (OUTPUT_TOKENS / TOKENS_PER_MILLION) * 12.00;
    } else if (modelName === 'gemini-3-flash-preview') {
      inputCost = (INPUT_TOKENS / TOKENS_PER_MILLION) * 0.50;
      outputCost = (OUTPUT_TOKENS / TOKENS_PER_MILLION) * 3.00;
    } else if (modelName === 'gemini-2.5-pro') {
      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ <= 200,000 ãƒˆãƒ¼ã‚¯ãƒ³ã®å ´åˆ
      inputCost = (INPUT_TOKENS / TOKENS_PER_MILLION) * 1.25;
      outputCost = (OUTPUT_TOKENS / TOKENS_PER_MILLION) * 10.00;
    } else if (modelName === 'gemini-2.5-flash') {
      inputCost = (INPUT_TOKENS / TOKENS_PER_MILLION) * 0.30;
      outputCost = (OUTPUT_TOKENS / TOKENS_PER_MILLION) * 2.50;
    }
    
    const totalCostUSD = inputCost + outputCost;
    const totalCostJPY = Math.round(totalCostUSD * USD_TO_JPY);
    return totalCostJPY;
  }

  /* --- å®šæ•°ãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ --- */
  const FORMAT_RULES = `
ã€å‡ºåŠ›å½¢å¼ã®å³å®ˆäº‹é …ã€‘
1. é›»å­ã‚«ãƒ«ãƒ†(iNote)è²¼ä»˜ç”¨ã€‚Markdownè¨˜æ³•ã¯ç¦æ­¢ã€‚
2. è¦‹å‡ºã—ã¯ã€ ã€‘ï¼ˆéš…ä»˜ãæ‹¬å¼§ï¼‰ã§å›²ã‚€ã€‚
3. æ–‡ä½“ã¯å°‚é–€åŒ»ã¨ã—ã¦é©åˆ‡ã«ï¼ˆã§ã‚ã‚‹èª¿ãªã©ï¼‰ã€‚
4. æ©Ÿç¨®ä¾å­˜æ–‡å­—ã‚„å¤‰æ›ä¸èƒ½ãªç‰¹æ®Šè¨˜å·ã¯ä½¿ç”¨ã›ãšã€åŠè§’è‹±æ•°è¨˜å·ã§ä»£ç”¨ã™ã‚‹ã“ã¨ã€‚
`;

  const ANTI_HALLUCINATION_RULES = `
ã€ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³(æé€ )é˜²æ­¢ã¨è‡ªç„¶ãªè¨˜è¿°ã€‘
åŒ»ç™‚æ–‡æ›¸ã«ãŠã„ã¦è™šå½è¨˜è¼‰ã¯å³ç¦ã§ã™ã€‚
1. ä¸æ˜ãªæ•°å€¤ãƒ»è©³ç´°ã¯ã€Œä¸æ˜ã€ã¨æ›¸ã‹ãšã€åˆ¤æ˜ã—ã¦ã„ã‚‹äº‹å®Ÿã®ã¿ã§è‡ªç„¶ãªæ–‡ç« ã‚’æ§‹æˆã™ã‚‹ã€‚
2. æ—¥ä»˜ã‚„ç”¨é‡ãŒä¸æ˜ãªå ´åˆã‚‚ã€æ³¨é‡ˆã‚’å…¥ã‚Œãšã«çœç•¥ã™ã‚‹ã‹ã€å‰å¾Œé–¢ä¿‚ã§è¨˜è¿°ã™ã‚‹ã€‚
`;

  const RECEIPT_RULES = `
ã€ãƒ¬ã‚»ãƒ—ãƒˆå¯©æŸ»å¯¾ç­–ï¼ˆç—‡çŠ¶è©³è¨˜ï¼‰ã®é‰„å‰‡ã€‘
ç—‡çŠ¶è©³è¨˜ãŒå¿…è¦ãªé …ç›®ã¯ã€DPCåŒ…æ‹¬éƒ¨åˆ†ï¼ˆå…¥é™¢åŸºæœ¬æ–™ã€æŠ•è–¬ã€æ³¨å°„ã€æ¤œæŸ»ã€ç—…ç†è¨ºæ–­ã€ç”»åƒè¨ºæ–­ã€1000ç‚¹æœªæº€ã®å‡¦ç½®ï¼‰ã¨å‡ºæ¥é«˜æ‰•ã„éƒ¨åˆ†ï¼ˆåŒ»å­¦ç®¡ç†ã€æ‰‹è¡“ã€éº»é…”ã€æ”¾å°„ç·šæ²»ç™‚ã€ãƒªãƒãƒ“ãƒªã€1000ç‚¹ä»¥ä¸Šã®å‡¦ç½®ï¼‰ã«åˆ†ã‹ã‚Œã¦ã„ã¾ã™ã€‚

å¯©æŸ»å“¡ï¼ˆåŒ»å¸«ï¼‰ã«ã‚ˆã‚‹æŸ»å®šï¼ˆæ¸›ç‚¹ï¼‰ã‚’é˜²ããŸã‚ã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã™ã‚‹ã“ã¨ã€‚å¯©æŸ»å“¡ã¯åŒ»å¸«ã§ã™ãŒã€å°‚é–€ã¯å¤šç¨®å¤šæ§˜ã§ã™ã€‚ã©ã®ã‚ˆã†ãªèƒŒæ™¯ã®å¯©æŸ»å“¡ã«å½“ãŸã‚‹ã‹ã¯åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚1æšå½“ãŸã‚Šã«ã‹ã‘ã‚‹æ™‚é–“ã¯ã€ç°¡å˜ãªãƒ¬ã‚»ãƒ—ãƒˆã¯æ•°ç§’ã€é«˜é¡ãƒ¬ã‚»ãƒ—ãƒˆã§ã‚‚æ•°åç§’ã‹ã‚‰æ•°åˆ†ç¨‹åº¦ã§ã™ã€‚å¯©æŸ»å“¡ã«ã¯åŒ»å¸«ã®è£é‡æ¨©ãŒã‚ã‚Šã¾ã™ã€‚

1. **ä¸€èˆ¬çš„æ³¨æ„äº‹é …**:
   - é•·æ–‡ãƒ»åæ–‡ã¯ç¦æ­¢ã€‚è¦ç‚¹ã®ã¿ã‚’æ˜ç­ãƒ»æ˜ç¢ºã«ç®‡æ¡æ›¸ãã§è¨˜è¼‰ã€‚
   - Keyã¨ãªã‚‹æ•°å€¤ï¼ˆå¤‰åŒ–ï¼‰ã¯å¿…ãšè¨˜è¼‰ã™ã‚‹ã€‚
   - æ¨ªæ–‡å­—ãƒ»ç•¥å·ã¯å¯èƒ½ãªé™ã‚Šé¿ã‘ã€æ—¥æœ¬èªã®å°‚é–€ç”¨èªã‚’ä½¿ç”¨ã™ã‚‹ã€‚
   - é©åˆ‡ãªæ—¥æœ¬èªãŒãªã„å ´åˆã€åˆå›ã®è¨˜è¼‰ã¯ãƒ•ãƒ«ã‚¹ãƒšãƒ«ã¨ç•¥å·ã‚’ä½µè¨˜ã™ã‚‹ï¼ˆä¾‹: ä½ä½“æ¸©ç™‚æ³•(TTM)ï¼‰ã€‚
   - åŒ»äº‹èª²ã®ä¾é ¼ã¸æ„šç›´ã«ç­”ãˆã‚‹ã€‚ç—‡çŠ¶è©³è¨˜ãŒå¿…è¦ãªå ´åˆã€ç°¡æ½”ã‹ã¤æ˜ç­ã«è¨˜è¼‰ã™ã‚‹ã“ã¨ã€‚

2. **NGãƒ¯ãƒ¼ãƒ‰ç¦æ­¢ã¨ç½®æ›**:
   - ç¦æ­¢: ã€Œæ‚£è€…ã®å¸Œæœ›ã«ã‚ˆã‚Šã€ã€Œå½“æ–½è¨­ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«ã‚ˆã‚Šã€ã€Œã€œè«–æ–‡ã‚’å‚è€ƒã«ã€ã€Œã€œã¨è€ƒãˆã‚‰ã‚Œã‚‹ã€
   - æ¨å¥¨: ã€Œæ—¥æœ¬å›½å†…ã®å­¦ä¼šã‹ã‚‰ç™ºè¡¨ã•ã‚Œã¦ã„ã‚‹ã€œã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã£ã¦ã€ã€Œå®Ÿéš›ã«éµå®ˆã—ãŸï¼ˆã—ã‚ˆã†ã¨åŠªã‚ãŸï¼‰ã€ã€ŒåŒ»å­¦çš„ã«å¿…è¦ã§ã‚ã£ãŸãŸã‚ã€

3. **æ•‘å‘½æ•‘æ€¥ç®¡ç†ã®å¿…è¦æ€§ï¼ˆè©²å½“ã™ã‚‹å ´åˆå¿…ãšè¨˜è¼‰ï¼‰**:
   - æ¥é™¢æ™‚ã®çŠ¶æ…‹ï¼ˆç·Šæ€¥åº¦ãƒ»é‡ç—‡åº¦ãŒé«˜ã„ã€ä¾µè¥²çš„æ²»ç™‚ã®å¿…è¦æ€§ãªã©ï¼‰ã‚’è¨˜è¼‰ã€‚
   - ICU/æ•‘æ€¥ç—…æ£Ÿç®¡ç†ãŒãã®æœŸé–“å¿…è¦ã ã£ãŸç†ç”±ã‚’å…·ä½“çš„ã«è¨˜è¼‰:
     * äººå·¥å‘¼å¸ç®¡ç†ç¶™ç¶šãŒå¿…è¦
     * æŠœç®¡å¾Œã®å‘¼å¸çŠ¶æ…‹ãŒä¸å®‰å®šã§å³é‡ãªçµŒéè¦³å¯ŸãŒå¿…è¦
     * å¾ªç’°å‹•æ…‹ãŒä¸å®‰å®šã§å¤§é‡è¼¸æ¶²ãƒ»è¼¸è¡€ãƒ»ã‚«ãƒ†ã‚³ãƒ©ãƒŸãƒ³ãŒå¿…è¦
     * è˜‡ç”Ÿå¾Œã‚„é ­éƒ¨å¤–å‚·å¾Œã§ä¸­æ¢ç¥çµŒç®¡ç†ï¼ˆTTMã‚’å«ã‚€ï¼‰ãŒå¿…è¦
   - **æ•—è¡€ç—‡**: åŸå› ã¨ãªã£ãŸç—…åã¨SOFAã‚¹ã‚³ã‚¢(â‰¥2)ã‚’å¿…ãšè¨˜è¼‰ã€‚
   - **æ•—è¡€ç—‡æ€§ã‚·ãƒ§ãƒƒã‚¯**: ä¹³é…¸å€¤(Lacâ‰¥2mmol/L)ã¨ã‚«ãƒ†ã‚³ãƒ©ãƒŸãƒ³æŠ•ä¸ã‚’å¿…ãšè¨˜è¼‰ã€‚

4. **æ‰‹è¡“ã®å¿…è¦æ€§ï¼ˆè©²å½“ã™ã‚‹å ´åˆå¿…ãšè¨˜è¼‰ï¼‰**:
   - ãã®æ‰‹è¡“ã‚’è¦ã—ãŸç†ç”±ã‚’å¿…ãšè¨˜è¼‰ã€‚
   - æ‰‹è¡“è¨˜éŒ²ã®è»¢è¨˜ã¯å¿…é ˆã§ãªã„ãŒã€è¡€ç®¡å†…æ²»ç™‚ãªã©ãƒ‡ãƒã‚¤ã‚¹ã‚’å¤šãä½¿ç”¨ã™ã‚‹æ‰‹è¡“ã‚„ã€æ—¥é ƒã‚ˆã‚Šã‚‚å¤šãã®åŒ»ç™‚ææ–™ã‚’è¦ã—ãŸæ‰‹è¡“ãªã©ã«ã¤ã„ã¦ã¯ã€å¿…è¦æ€§ã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã«æ‰‹è¡“è¨˜éŒ²ã‚’è»¢è¨˜ã—ã¦ãŠãã€‚

5. **è¼¸è¡€ã®å¿…è¦æ€§ï¼ˆè©²å½“ã™ã‚‹å ´åˆå¿…ãšè¨˜è¼‰ï¼‰**:
   - è¡€æ¶²è£½å‰¤ã®ä½¿ç”¨æŒ‡é‡ã‚’å‚ç…§ã—ã€ç—…æ…‹ã«åˆã‚ã›ãŸHb, PLT, å‡å›ºç³»ã®ç›®æ¨™å€¤ã‚’æ˜è¨˜ã€‚
   - è¼¸è¡€å‰å¾Œã®æ¤œæŸ»å€¤ã‚’å¿…ãšè¨˜è¼‰ã€‚
   - **å‘¨è¡“æœŸã‚„é€šå¸¸è¨ºç™‚ã«ãŠã‘ã‚‹è¼¸è¡€**: ã€Œè¡€æ¶²è£½å‰¤ã®ä½¿ç”¨æŒ‡é‡ã®æ¨å¥¨ã«å¾“ã„ã€ã€œã‚’ç›®æ¨™ã«é©æ­£ãªè¼¸è¡€ã‚’å®Ÿæ–½ã—ãŸï¼ˆè©¦ã¿ãŸï¼‰ã€‚ã€
   - **æ¯”è¼ƒçš„å¤šé‡ã®è¼¸è¡€ã‚’è¡Œã£ãŸå ´åˆ**: ä¸Šè¨˜ã«åŠ ãˆã€Œæ€¥é€Ÿã«ä½ä¸‹ã—ã¦ãŠã‚Šã€å‡ºè¡€ã®äºˆæƒ³ã•ã‚Œã‚‹è¡“ä¸­ã«ãŠã„ã¦ã‚‚ç›®æ¨™å€¤ãŒç¶­æŒã•ã‚Œã‚‹ã‚ˆã†ã«ã€ã€Œä¸­å¿ƒé™è„ˆã‚«ãƒ†ãƒ¼ãƒ†ãƒ«æŒ¿å…¥éƒ¨ã‚ˆã‚Šè‡¨åºŠçš„ãªå‡ºè¡€å‚¾å‘ã‚’èªã‚ã¦ãŠã‚Šã€ãªã©ã®æ–‡è¨€ã‚’è¿½åŠ ã€‚
   - **å¤§é‡å‡ºè¡€æ™‚**: ã€Œå¤§é‡å‡ºè¡€ç—‡ä¾‹ã«å¯¾ã™ã‚‹è¡€æ¶²è£½å‰¤ã®é©æ­£ä½¿ç”¨ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®æ¨å¥¨ã«å¾“ã„ã€å¤§é‡è¼¸è¡€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®Ÿæ–½ã—ãŸï¼ˆè©¦ã¿ãŸï¼‰ã€‚ã€

6. **å‡¦ç½®ã®å¿…è¦æ€§ï¼ˆè©²å½“ã™ã‚‹å ´åˆå¿…ãšè¨˜è¼‰ï¼‰**:
   - ãã®å‡¦ç½®ã‚’è¦ã—ãŸç†ç”±ã‚’å¿…ãšè¨˜è¼‰ã€‚é©å¿œã€æ—¥æ•°ãŠã‚ˆã³æšæ•°åˆ¶é™ã«æ³¨æ„ã€‚
   - **ä½ä½“æ¸©ç™‚æ³•(TTM)**: å¿ƒè‚ºè˜‡ç”Ÿå¾Œã®TTMã€35â„ƒä»¥ä¸‹ã€æœ€å¤§3æ—¥é–“ç®—å®šã€‚ã‚µãƒ¼ãƒ¢ã‚¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ /ICYã‚«ãƒ†ãƒ¼ãƒ†ãƒ«ã€ãƒ–ãƒ©ãƒ³ã‚±ãƒƒãƒˆã‚’ä½¿ç”¨ã€‚
   - **çµŒçš®çš„ä½“æ¸©èª¿ç¯€ç™‚æ³•**: æ€¥æ€§é‡ç—‡è„³éšœå®³ï¼ˆSAH, é ­éƒ¨å¤–å‚·, ç†±ä¸­ç—‡ï¼‰ã®TTMã€1å›ã®ã¿ç®—å®šã€‚ã‚µãƒ¼ãƒ¢ã‚¬ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ /ICYã‚«ãƒ†ãƒ¼ãƒ†ãƒ«ã‚’ä½¿ç”¨ã€‚
   - **å±€æ‰€é™°åœ§é–‰é–å‡¦ç½®(VAC, ãƒ™ãƒ©ãƒ•ãƒ­, ABTHERAç­‰)**: 
     * æ®ãˆç½®ãå‹ï¼ˆVACã‚„ãƒ™ãƒ©ãƒ•ãƒ­ï¼‰ã¯æœ€å¤§4é€±é–“ã€é€£æ—¥ç®—å®šå¯ã€‚
     * ABTHERAã¯æœ€å¤§10æ—¥é–“ã€5æšã®äº¤æ›ã¾ã§ç®—å®šå¯ã€‚
     * ABTHERAã¨VACã‚’ä½µã›ã¦ç®—å®šã¯ä¸å¯ã€‚
     * ç®—å®šé™åº¦ã‚’è¶…ãˆã¦ä½¿ç”¨ã—ãŸå ´åˆã¯ã€å¿…è¦æ€§ã‚’åˆ‡å®Ÿã«è¨˜è¼‰ã€‚
   - **æŒç¶šç·©å¾å¼è¡€æ¶²æ¿¾é(CHDF)**: 
     * é©å¿œ: æœ«æœŸè…ä¸å…¨ã€æ€¥æ€§è…éšœå®³ï¼ˆé«˜åº¦ä»£è¬æ€§ã‚¢ã‚·ãƒ‰ãƒ¼ã‚·ã‚¹ã€å°¿æ¯’ç—‡ã€é›»è§£è³ªç•°å¸¸ã€ä½“æ¶²éå‰°çŠ¶æ…‹ï¼‰ã€è–¬ç‰©ä¸­æ¯’ã€é‡ç—‡æ•—è¡€ç—‡ã€æ¿€ç—‡è‚ç‚åˆã¯è¡“å¾Œè‚ä¸å…¨ã‚’å‘ˆã™ã‚‹æ€¥æ€§è‚ä¸å…¨ã€é‡ç—‡æ€¥æ€§è†µç‚ï¼ˆæ€¥æ€§è†µç‚è¨ºç™‚ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³2015ã«åŸºã¥ãï¼‰
     * æ…¢æ€§ç¶­æŒé€æ(HD)ã¨ä½µã›ã¦æœˆ14å›ã¾ã§ï¼ˆé‡ç—‡æ€¥æ€§è†µç‚ã¯æœˆ8å›ã¾ã§ã€æ•—è¡€ç—‡æ€§ã‚·ãƒ§ãƒƒã‚¯ã¯æœˆ8å›ã¾ã§ã€æ€¥æ€§è‚ä¸å…¨ã¯æœˆ10å›3ãƒ¶æœˆã¾ã§ï¼‰

7. **æ•°å€¤ã®æ‰±ã„**:
   - é‡ç—‡åº¦ã‚’ç¤ºã™æ•°å€¤ï¼ˆGCS, SpO2, BP, Lac, SOFAç­‰ï¼‰ã¯åˆ¤æ˜ã—ã¦ã„ã‚‹é™ã‚Šå¿…ãšè¨˜è¼‰ã™ã‚‹ã€‚
   - æ•°å€¤ã®å¤‰åŒ–ï¼ˆæ”¹å–„ãƒ»æ‚ªåŒ–ï¼‰ã‚‚å¯èƒ½ãªé™ã‚Šè¨˜è¼‰ã™ã‚‹ã€‚
`;

  const MODE_HINTS = {
    summary: {
      hint: '<strong>é€€é™¢ã‚µãƒãƒªãƒ¼</strong>: æŒ‡å®šã®13é …ç›®ã‚’ç¶²ç¾…ã€‚è©³ç´°ä¸æ˜ãªç‚¹ã¯è‡ªç„¶ã«çœç•¥ã—ã€ç·¨é›†ä¸è¦ãªå®Œæˆç¨¿ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚',
      placeholder: 'è£œè¶³ãƒ¡ãƒ¢ (ä¾‹: å…¥é™¢æ™‚æ‰€è¦‹ã®è©³ç´°ã€é€€é™¢æ™‚ã®ç‰¹åˆ¥ãªæŒ‡ç¤ºãªã©)'
    },
    shoki: {
      hint: '<strong>ç—‡çŠ¶è©³è¨˜ (ãƒ¬ã‚»ãƒ—ãƒˆå¯¾ç­–)</strong>: 4é …ç›®æ§‹æˆï¼ˆè‡¨åºŠç—‡çŠ¶ã€è¨ºå¯Ÿãƒ»æ¤œæŸ»æ‰€è¦‹ã€æ²»ç™‚ã®å¿…è¦æ€§ã€æ²»ç™‚ã®çµŒéï¼‰ã€‚ã€Œæ‚£è€…å¸Œæœ›ã€ç­‰ã¯ç¦æ­¢ã€‚',
      placeholder: 'è£œè¶³ãƒ¡ãƒ¢ (ä¾‹: æ•—è¡€ç—‡ã®åŸå› ã€è¼¸è¡€å‰å¾Œã®ãƒ‡ãƒ¼ã‚¿ã€ICUå…¥å®¤ã®å…·ä½“çš„ç†ç”±ã€æ‰‹è¡“ã®é©å¿œ)'
    },
    letter: {
      hint: '<strong>ç´¹ä»‹çŠ¶</strong>: å®›å…ˆåŒ»ç™‚æ©Ÿé–¢ã‚’å…¥åŠ›ã—ã€çµŒéã‚’ã¾ã¨ã‚ãŸç´¹ä»‹çŠ¶ã‚’ä½œæˆã€‚é€†ç´¹ä»‹ãƒ»è»¢é™¢æ™‚ã«ã€‚',
      placeholder: 'çµŒéã‚„ç´¹ä»‹ç†ç”± (ä¾‹: å½“é™¢ã§ã®åŠ ç™‚çµ‚äº†ã€è¡“å¾Œãƒ•ã‚©ãƒ­ãƒ¼ãŠé¡˜ã„ã—ãŸã„)'
    },
    consult: {
      hint: '<strong>ã‚³ãƒ³ã‚µãƒ«ãƒˆ</strong>: é™¢å†…ä»–ç§‘ã¸ã®å¯¾è¨ºä¾é ¼æ–‡ã‚’ä½œæˆã€‚å®›å…ˆãƒ»ç›®çš„ã‚’æ˜ç¢ºã«å…¥åŠ›ã™ã‚‹ã¨ç²¾åº¦UPã€‚',
      placeholder: 'è£œè¶³ãƒ¡ãƒ¢ (ä¾‹: ç”»åƒã®ã“ã“ã‚’è¦‹ã¦ã»ã—ã„ã€ç·Šæ€¥åº¦é«˜ã„)'
    },
    'summary-shoki': {
      hint: '<strong>ã‚µãƒãƒªãƒ¼ï¼†è©³è¨˜</strong>: é€€é™¢ã‚µãƒãƒªãƒ¼ã¨ç—‡çŠ¶è©³è¨˜ã‚’é †ç•ªã«ç”Ÿæˆã—ã¾ã™ã€‚åŒä¸€ã®å…¥åŠ›ã§ä¸¡æ–¹ã‚’ä¸€æ‹¬å‡ºåŠ›ã§ãã¾ã™ã€‚',
      placeholder: 'è£œè¶³ãƒ¡ãƒ¢ (ä¾‹: å…¥é™¢æ™‚æ‰€è¦‹ã®è©³ç´°ã€æ•—è¡€ç—‡ã®åŸå› ã€è¼¸è¡€å‰å¾Œã®ãƒ‡ãƒ¼ã‚¿ãªã©)'
    }
  };

  /* --- è¨ºç™‚ç§‘ãƒªã‚¹ãƒˆ --- */
  const DEPARTMENT_LIST = [
    'å†…ç§‘',
    'å°å…ç§‘',
    'ç³–å°¿ç—…ãƒ»å†…åˆ†æ³Œå†…ç§‘',
    'è¡€æ¶²ãƒ»è† åŸç—…å†…ç§‘',
    'è…è‡“å†…ç§‘',
    'è„³ç¥çµŒå†…ç§‘',
    'æ¶ˆåŒ–å™¨å†…ç§‘',
    'å¾ªç’°å™¨å†…ç§‘',
    'å‘¼å¸å™¨å†…ç§‘',
    'æ–°ç”Ÿå…å†…ç§‘',
    'è…«ç˜å†…ç§‘',
    'æ”¾å°„ç·šç§‘',
    'éº»é…”ç§‘',
    'ãƒªã‚¦ãƒãƒç§‘',
    'æ¶ˆåŒ–å™¨å¤–ç§‘',
    'å‘¼å¸å™¨å¤–ç§‘',
    'å¿ƒè‡“è¡€ç®¡å¤–ç§‘',
    'ä¹³è…ºå¤–ç§‘',
    'å°å…å¤–ç§‘',
    'æ•´å½¢å¤–ç§‘',
    'å½¢æˆå¤–ç§‘',
    'è„³ç¥çµŒå¤–ç§‘',
    'çš®è†šç§‘',
    'æ³Œå°¿å™¨ç§‘',
    'ç”£å©¦äººç§‘',
    'è€³é¼»å’½å–‰ç§‘',
    'çœ¼ç§‘',
    'æ­¯ç§‘ãƒ»æ­¯ç§‘å£è…”å¤–ç§‘'
  ];

  /* --- åˆæœŸåŒ– --- */
  window.onload = () => {
    document.getElementById('apiKeyInput').value = apiKey;
    const select = document.getElementById('modelSelect');
    if (![...select.options].some(o => o.value === currentModel)) {
       select.value = 'custom';
       document.getElementById('customModelInput').style.display = 'block';
       document.getElementById('customModelInput').value = currentModel;
    } else { select.value = currentModel; }
    updateBadge();

    document.getElementById('sourceDept').value = localStorage.getItem('med_doc_source_dept') || '';
    document.getElementById('referrerName').value = localStorage.getItem('med_doc_referrer_name') || '';

    // è¨ºç™‚ç§‘ãƒªã‚¹ãƒˆã‚’è¨­å®š
    const targetDeptSelect = document.getElementById('targetDept');
    DEPARTMENT_LIST.forEach(dept => {
      const option = document.createElement('option');
      option.value = dept;
      option.textContent = dept;
      targetDeptSelect.appendChild(option);
    });

    // customModelInputã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    document.getElementById('customModelInput').addEventListener('change', function(){
      currentModel = this.value.trim() || 'gemini-2.5-pro';
      localStorage.setItem('med_gen_model', currentModel);
      updateBadge();
    });

    if (!apiKey) {
      document.getElementById('settingsOverlay').style.display = 'block';
      document.getElementById('settingsArea').style.display = 'block';
    }
    setMode('summary');
  };

  /* --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ --- */
  function getBasePrompt(mode) {
    if (mode === 'summary') {
      return `ã‚ãªãŸã¯æŒ‡å°åŒ»ã§ã™ã€‚ä»¥ä¸‹ã®ã€å¿…é ˆæ§‹æˆã€‘ã«å¾“ã„ã€æ¼ã‚Œãªãè©³ç´°ãªé€€é™¢æ™‚ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
${FORMAT_RULES}
${ANTI_HALLUCINATION_RULES}

ã€è¨˜è¼‰ã‚¹ã‚¿ã‚¤ãƒ«ã®å³å®ˆäº‹é …ã€‘
1. è–¬å‰¤è¨˜è¼‰: ã€Œä¸€èˆ¬å(å•†å“å) 1å›é‡ æŠ•ä¸çµŒè·¯ æŠ•ä¸é–“éš”/é€Ÿåº¦ã€ãŒåŸºæœ¬ã ãŒã€ç”¨é‡ä¸æ˜æ™‚ã¯ã€Œè–¬å‰¤å æŠ•ä¸çµŒè·¯ã€ã®ã¿è¨˜è¼‰ã€‚
2. è¼¸æ¶²ãƒ»è¼¸è¡€: ç·é‡ãŒåˆ¤æ˜ã—ã¦ã„ã‚Œã°è¨˜è¼‰ã€‚ä¸æ˜ãªã‚‰è£½å‰¤åã¨å®Ÿæ–½ã®äº‹å®Ÿã®ã¿è¨˜è¼‰ã€‚
3. æ¤œæŸ»å€¤: ã€Œé …ç›®å å€¤ã€ã®å½¢å¼ã€‚å€¤ãŒä¸æ˜ãªé …ç›®ã¯è¨˜è¼‰ã—ãªã„ã€‚

ã€å¿…é ˆæ§‹æˆã€‘
ã€ä¸»è¨´ã€‘
ã€ç¾ç—…æ­´ã€‘
ã€æ—¢å¾€æ­´ã€‘
ã€å¸¸ç”¨è–¬ã€‘
ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã€‘
ã€ç”Ÿæ´»æ­´ã€‘
ã€å…¥é™¢æ™‚èº«ä½“æ‰€è¦‹ã€‘
ã€å…¥é™¢æ™‚æ¤œæŸ»æ‰€è¦‹ã€‘
ã€é‘‘åˆ¥è¨ºæ–­ã€‘
ã€ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ãƒªã‚¹ãƒˆã€‘
ã€å…¥é™¢å¾ŒçµŒéã¨æ²»ç™‚ã€‘
(ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ã”ã¨ã«è¨˜è¿°ã€‚åˆ¤æ˜ã—ã¦ã„ã‚‹æƒ…å ±ã ã‘ã§è‡ªç„¶ãªæ–‡ç« ã«ã™ã‚‹ã“ã¨)
ã€æ™‚ç³»åˆ—ã‚µãƒãƒªãƒ¼ã€‘
(å…¥é™¢ã‹ã‚‰é€€é™¢ã¾ã§ã®ä¸»è¦ãªå‡ºæ¥äº‹ã‚’æ—¥ä»˜é †ã«ã¾ã¨ã‚ã¦è¨˜è¼‰ã™ã‚‹ã“ã¨ã€‚æ‰‹è¡“ã€å‡¦ç½®ã€æ¤œæŸ»ã€æ²»ç™‚é–‹å§‹ãƒ»å¤‰æ›´ã€åˆä½µç—‡ã®ç™ºç—‡ã€è»¢ç§‘ã€é€€é™¢ãªã©ã€åˆ¤æ˜ã—ã¦ã„ã‚‹æ—¥ä»˜ã¨ã¨ã‚‚ã«ä¸»è¦ãªå‡ºæ¥äº‹ã‚’æ™‚ç³»åˆ—ã§è¨˜è¼‰ã€‚æ—¥ä»˜ãŒä¸æ˜ãªå ´åˆã¯å…¥é™¢æ—¥æ•°ï¼ˆä¾‹ï¼šå…¥é™¢3æ—¥ç›®ï¼‰ã§è¨˜è¼‰ã€‚ä¸€ç›®ã§çµŒéãŒæŠŠæ¡ã§ãã‚‹ã‚ˆã†ç°¡æ½”ã«ç®‡æ¡æ›¸ãã§è¨˜è¼‰ã™ã‚‹ã“ã¨)
ã€é€€é™¢æ™‚çŠ¶æ…‹ã€‘
ã€é€€é™¢å¾Œæ–¹é‡ã€‘

â€»å…¥åŠ›æƒ…å ±ã«è¨˜è¼‰ãŒãªã„é …ç›®ã¯ã€Œè¨˜è¼‰ãªã—ã€ã¨ã—ã€ã€Œä¸æ˜ã€ç­‰ã®æ³¨é‡ˆã¯å…¥ã‚Œãªã„ã“ã¨ã€‚`;
    }
    if (mode === 'shoki') {
      // ãƒ¬ã‚»ãƒ—ãƒˆå¯¾ç­–ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨
      return `ã‚ãªãŸã¯ä¿é™ºå¯©æŸ»ã«ç²¾é€šã—ãŸåŒ»å¸«ã§ã™ã€‚æ•‘å‘½æ•‘æ€¥å…¥é™¢æ–™ã‚„é«˜é¡å‡¦ç½®ã®åŒ»å­¦çš„å¿…è¦æ€§ã‚’ä¸»å¼µã—ã€æŸ»å®šï¼ˆæ¸›ç‚¹ï¼‰ã‚’é˜²ããŸã‚ã®å®Œç’§ãªç—‡çŠ¶è©³è¨˜ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
${FORMAT_RULES}
${ANTI_HALLUCINATION_RULES}
${RECEIPT_RULES}

ã€é‡è¦ã€‘æ–‡ä½“ã«ã¤ã„ã¦ï¼šã™ã¹ã¦ã€Œã§ã™ã¾ã™èª¿ã€ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ã€Œã§ã‚ã‚‹ã€ã€Œã ã£ãŸã€ãªã©ã®ã§ã‚ã‚‹èª¿ã¯ä½¿ç”¨ã›ãšã€ã€Œã§ã™ã€ã€Œã¾ã™ã€ã€Œã§ã—ãŸã€ãªã©ã®ã§ã™ã¾ã™èª¿ã§çµ±ä¸€ã—ã¦ãã ã•ã„ã€‚

ã€å¿…é ˆæ§‹æˆï¼ˆã“ã®é †åºã§å¿…ãšè¨˜è¼‰ã™ã‚‹ã“ã¨ï¼‰ã€‘

ã€æ‚£è€…ã®ä¸»ãŸã‚‹ç–¾æ‚£ï¼ˆåˆä½µç—‡ã‚’å«ã‚€ã€‚ï¼‰ã®è¨ºæ–­æ ¹æ‹ ã¨ãªã£ãŸè‡¨åºŠç—‡çŠ¶ã€‘
(ä¸»è¨´ã€ç¾ç—…æ­´ã€æ™‚ç³»åˆ—ã§ã®ç—‡çŠ¶ã®çµŒéã‚’è¨˜è¿°ã€‚é‡ç—‡åº¦æŒ‡æ¨™ GCS/SpO2/è¡€åœ§/SOFAç­‰ã‚’å«ã‚€ã€‚åˆ¤æ˜ã—ã¦ã„ã‚‹æƒ…å ±ã®ã¿ã§è‡ªç„¶ãªæ–‡ç« ã«ã™ã‚‹ã“ã¨ã€‚å¿…ãšã§ã™ã¾ã™èª¿ã§è¨˜è¿°ã™ã‚‹ã“ã¨)
ã€é‡è¦ã€‘æ•°å€¤ã¨æ™‚ç³»åˆ—ã®è¨˜è¼‰ã«ã¤ã„ã¦ï¼š
- æ—¥ä»˜ã‚„å…¥é™¢æ—¥æ•°ã‚’å¿…ãšè¨˜è¼‰ï¼ˆä¾‹ï¼šã€Œâ—‹æœˆâ—‹æ—¥ã€ã€Œå…¥é™¢â—‹æ—¥ç›®ã€ãªã©ï¼‰
- ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ï¼ˆè¡€åœ§ã€è„ˆæ‹ã€ä½“æ¸©ã€SpO2ã€å‘¼å¸æ•°ãªã©ï¼‰ã¯å…·ä½“çš„ãªæ•°å€¤ã¨å˜ä½ã‚’å¿…ãšè¨˜è¼‰ã—ã€çµŒæ™‚çš„å¤‰åŒ–ã‚’ç¤ºã™ï¼ˆä¾‹ï¼šã€Œè¡€åœ§120/80mmHgã‹ã‚‰90/60mmHgã«ä½ä¸‹ã€ï¼‰
- é‡ç—‡åº¦æŒ‡æ¨™ï¼ˆGCSã€SOFAã‚¹ã‚³ã‚¢ãªã©ï¼‰ã¯å…·ä½“çš„ãªæ•°å€¤ã‚’å¿…ãšè¨˜è¼‰
- æ•°å€¤ã®æ¨ç§»ã‚’ç¤ºã™éš›ã¯ã€å‰å¾Œã®å€¤ã‚’æ¯”è¼ƒã—ã¦è¨˜è¼‰ã™ã‚‹ã“ã¨

ã€æ‚£è€…ã®ä¸»ãŸã‚‹ç–¾æ‚£ï¼ˆåˆä½µç—‡ã‚’å«ã‚€ã€‚ï¼‰ã®è¨ºæ–­æ ¹æ‹ ã¨ãªã£ãŸè‡¨åºŠç—‡çŠ¶ã®è¨ºå¯Ÿãƒ»æ¤œæŸ»æ‰€è¦‹ã€‘
(èº«ä½“æ‰€è¦‹ã€æ¤œæŸ»æ‰€è¦‹ï¼ˆè¡€æ¶²æ¤œæŸ»ã€ç”»åƒæ¤œæŸ»ç­‰ï¼‰ã€è¨ºæ–­ã«è‡³ã£ãŸæ ¹æ‹ ã‚’è¨˜è¿°ã€‚æ•°å€¤ãŒä¸æ˜ãªé …ç›®ã¯è¨˜è¼‰ã—ãªã„ã€‚å¿…ãšã§ã™ã¾ã™èª¿ã§è¨˜è¿°ã™ã‚‹ã“ã¨)
ã€é‡è¦ã€‘æ¤œæŸ»å€¤ã®è¨˜è¼‰ã«ã¤ã„ã¦ï¼š
- è¡€æ¶²æ¤œæŸ»å€¤ã¯å…·ä½“çš„ãªæ•°å€¤ã¨å˜ä½ã‚’å¿…ãšè¨˜è¼‰ï¼ˆä¾‹ï¼šã€ŒWBC 12000/Î¼Lã€CRP 15.2mg/dLã€ï¼‰
- æ¤œæŸ»å€¤ã®çµŒæ™‚çš„å¤‰åŒ–ã‚’ç¤ºã™éš›ã¯ã€æ—¥ä»˜ã‚„å…¥é™¢æ—¥æ•°ã¨ã¨ã‚‚ã«å‰å¾Œã®å€¤ã‚’æ¯”è¼ƒã—ã¦è¨˜è¼‰ï¼ˆä¾‹ï¼šã€Œå…¥é™¢1æ—¥ç›®ã®WBC 12000/Î¼Lã€CRP 15.2mg/dLã‹ã‚‰ã€å…¥é™¢3æ—¥ç›®ã«ã¯WBC 8000/Î¼Lã€CRP 8.5mg/dLã«æ”¹å–„ã€ï¼‰
- ç”»åƒæ¤œæŸ»ã®æ‰€è¦‹ã‚‚å…·ä½“çš„ã«è¨˜è¼‰ã—ã€æ—¥ä»˜ã‚’æ˜è¨˜ã™ã‚‹ã“ã¨

ã€ä¸»ãªæ²»ç™‚è¡Œç‚ºï¼ˆæ‰‹è¡“ã€å‡¦ç½®ã€è–¬ç‰©æ²»ç™‚ç­‰ï¼‰ã®å¿…è¦æ€§ã€‘
(ãªãœãã®å‡¦ç½®ãƒ»ICUç®¡ç†ãƒ»å…¥é™¢æ–™ãƒ»æ‰‹è¡“ãƒ»è–¬ç‰©æ²»ç™‚ãŒå¿…è¦ã ã£ãŸã‹ã€‚ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚„é‡ç—‡åº¦ã‚’æ ¹æ‹ ã«è¨˜è¿°ã€‚NGãƒ¯ãƒ¼ãƒ‰ã€Œæ‚£è€…ã®å¸Œæœ›ã«ã‚ˆã‚Šã€ç­‰ã¯ä½¿ç”¨ç¦æ­¢ã€‚å¿…ãšã§ã™ã¾ã™èª¿ã§è¨˜è¿°ã™ã‚‹ã“ã¨)
(â€»è¼¸è¡€ãŒã‚ã‚‹å ´åˆã¯å¿…ãšã€Œè¡€æ¶²è£½å‰¤ã®ä½¿ç”¨æŒ‡é‡ã«å¾“ã„ã€ã€œã‚’ç›®æ¨™ã«é©æ­£ãªè¼¸è¡€ã‚’å®Ÿæ–½ã—ãŸã€ã®å®šå‹æ–‡ã¨ç›®æ¨™å€¤ã‚’å…¥ã‚Œã‚‹)
ã€é‡è¦ã€‘æ•°å€¤ã«ã‚ˆã‚‹æ ¹æ‹ ã®è¨˜è¼‰ï¼š
- æ²»ç™‚ã®å¿…è¦æ€§ã‚’ç¤ºã™æ•°å€¤ï¼ˆãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã€æ¤œæŸ»å€¤ã€ã‚¹ã‚³ã‚¢ãªã©ï¼‰ã‚’å¿…ãšå…·ä½“çš„ã«è¨˜è¼‰
- æ•°å€¤ã®å¤‰åŒ–ã‚’ç¤ºã™éš›ã¯ã€å‰å¾Œã®å€¤ã‚’æ¯”è¼ƒã—ã¦è¨˜è¼‰ã™ã‚‹ã“ã¨

ã€ä¸»ãªæ²»ç™‚è¡Œç‚ºï¼ˆæ‰‹è¡“ã€å‡¦ç½®ã€è–¬ç‰©æ²»ç™‚ç­‰ï¼‰ã®çµŒéã€‘
(å®Ÿæ–½ã—ãŸæ²»ç™‚ã®çµŒéã‚’æ™‚ç³»åˆ—ã§è¨˜è¿°ã€‚æ‰‹è¡“ãƒ»å‡¦ç½®ã®å†…å®¹ã€è–¬ç‰©æ²»ç™‚ã®åŠ¹æœã€çµŒéè¦³å¯Ÿã®çµæœç­‰ã€‚åˆ¤æ˜ã—ã¦ã„ã‚‹æƒ…å ±ã®ã¿ã§è‡ªç„¶ãªæ–‡ç« ã«ã™ã‚‹ã“ã¨ã€‚å¿…ãšã§ã™ã¾ã™èª¿ã§è¨˜è¿°ã™ã‚‹ã“ã¨)
ã€é‡è¦ã€‘æ™‚ç³»åˆ—ã¨æ•°å€¤ã®è¨˜è¼‰ã«ã¤ã„ã¦ï¼š
- æ—¥ä»˜ã‚„å…¥é™¢æ—¥æ•°ã‚’å¿…ãšè¨˜è¼‰ã—ã¦æ™‚ç³»åˆ—ã‚’æ˜ç¢ºã«ã™ã‚‹ï¼ˆä¾‹ï¼šã€Œâ—‹æœˆâ—‹æ—¥ï¼ˆå…¥é™¢â—‹æ—¥ç›®ï¼‰ã«â—‹â—‹ã‚’å®Ÿæ–½ã€ï¼‰
- æ²»ç™‚å‰å¾Œã®ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã‚„æ¤œæŸ»å€¤ã®å¤‰åŒ–ã‚’å…·ä½“çš„ãªæ•°å€¤ã§è¨˜è¼‰ï¼ˆä¾‹ï¼šã€Œæ‰‹è¡“å‰ã®è¡€åœ§120/80mmHgã€Hb 12.0g/dLã‹ã‚‰ã€æ‰‹è¡“å¾Œã¯è¡€åœ§100/70mmHgã€Hb 9.5g/dLã¨ãªã£ãŸã€ï¼‰
- è–¬ç‰©æ²»ç™‚ã®åŠ¹æœã‚’ç¤ºã™éš›ã‚‚ã€æ•°å€¤ã®å¤‰åŒ–ã‚’å…·ä½“çš„ã«è¨˜è¼‰ã™ã‚‹ã“ã¨
- çµŒéè¦³å¯Ÿã®çµæœã‚‚ã€æ—¥ä»˜ã¨æ•°å€¤ã‚’ä½¿ã£ã¦æ™‚ç³»åˆ—ã§è¨˜è¼‰ã™ã‚‹ã“ã¨

â€»å„é …ç›®ã¯æ˜ç¢ºã«åŒºåˆ¥ã—ã€é‡è¤‡ãªãè¨˜è¿°ã™ã‚‹ã“ã¨ã€‚`;
    }
    return "";
  }

  /* --- å…±é€šå‡¦ç† --- */
  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
  function saveProfile() {
    localStorage.setItem('med_doc_source_dept', document.getElementById('sourceDept').value);
    localStorage.setItem('med_doc_referrer_name', document.getElementById('referrerName').value);
  }
  async function handleImageSelect(input) {
    if (input.files && input.files.length > 0) {
      let successCount = 0;
      let failCount = 0;
      for (let file of Array.from(input.files)) {
        try {
          await processAndAddImage(file);
          successCount++;
        } catch (e) {
          failCount++;
          console.error('ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼:', e);
        }
      }
      input.value = '';
      if (failCount > 0) {
        showToast(`${successCount}æšè¿½åŠ ã€${failCount}æšå¤±æ•—`, failCount === input.files.length ? 'error' : 'warning');
      } else {
        showToast(`${successCount}æšã®ç”»åƒã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
      }
    }
  }
  function processAndAddImage(file) {
    return new Promise((resolve, reject) => {
      if (!file.type.startsWith('image/')) {
        reject(new Error('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“'));
        return;
      }
      const reader = new FileReader();
      reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
      reader.onload = (e) => {
        const img = new Image();
        img.onerror = () => reject(new Error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        img.onload = () => {
          try {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height, max = 1500;
            if (w > h && w > max) { h *= max/w; w = max; } else if (h > max) { w *= max/h; h = max; }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            if (!ctx) {
              reject(new Error('Canvasã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ'));
              return;
            }
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            if (!dataUrl || dataUrl.length < 100) {
              reject(new Error('ç”»åƒã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ'));
              return;
            }
            currentImages.push(dataUrl.split(',')[1]);
            renderImageGrid();
            resolve();
          } catch (err) {
            reject(new Error('ç”»åƒå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message));
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  }
  function renderImageGrid() {
    const grid = document.getElementById('imageGrid'); grid.innerHTML = '';
    currentImages.forEach((b64, i) => {
      const div = document.createElement('div'); div.className = 'thumb-container';
      div.innerHTML = `<img src="data:image/jpeg;base64,${b64}" class="thumb-img"><button class="btn-remove-thumb" onclick="removeImg(${i})">Ã—</button>`;
      grid.appendChild(div);
    });
  }
  window.removeImg = (i) => { currentImages.splice(i, 1); renderImageGrid(); };
  function clearImages() { if(currentImages.length){ currentImages=[]; renderImageGrid(); showToast('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ','warning'); } }

  // å˜ä¸€ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆã‚µãƒãƒªãƒ¼ï¼†è©³è¨˜ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
  async function generateSingleDoc(mode, freeText) {
    const systemPrompt = getBasePrompt(mode);
    
    // å…¥åŠ›å†…å®¹ã«å¿œã˜ãŸcontentsPartsæ§‹ç¯‰
    const contentsParts = [];
    const hasImages = currentImages.length > 0;
    const hasText = freeText.length > 0;

    if (hasImages) {
      currentImages.forEach(d => contentsParts.push({ inline_data: { mime_type: "image/jpeg", data: d } }));
    }

    const instruction = "è©³ç´°ãŒèª­ã¿å–ã‚Œãªã„æƒ…å ±ã¯æé€ ã›ãšã€ã¾ãŸã€Œä¸æ˜ã€ã¨ã‚‚æ›¸ã‹ãšã«ã€åˆ¤æ˜ã—ã¦ã„ã‚‹æƒ…å ±ã ã‘ã§è‡ªç„¶ãªæ–‡ç« ã«ã™ã‚‹ã“ã¨ã€‚ç·¨é›†ã®æ‰‹é–“ã‚’çœããŸã‚ã€ä¸æ˜ãªç®‡æ‰€ã®æ³¨é‡ˆã¯ä¸è¦ã€‚";

    if (hasImages && hasText) {
      contentsParts.push({ text: `ä»¥ä¸‹ã®ç”»åƒ(ã‚«ãƒ«ãƒ†ç­‰)ã¨ãƒ¡ãƒ¢ã‚’çµ±åˆã—ã¦ä½œæˆã›ã‚ˆã€‚${instruction}\n\nã€ãƒ¡ãƒ¢ã€‘\n${freeText}` });
    } else if (hasImages) {
      contentsParts.push({ text: `ä»¥ä¸‹ã®ç”»åƒ(ã‚«ãƒ«ãƒ†ç­‰)ã‚’è§£æã—ã¦ä½œæˆã›ã‚ˆã€‚${instruction}` });
    } else {
      contentsParts.push({ text: `ä»¥ä¸‹ã®ãƒ¡ãƒ¢ã‚’å…ƒã«ä½œæˆã›ã‚ˆã€‚${instruction}\n\nã€ãƒ¡ãƒ¢ã€‘\n${freeText}` });
    }

    const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;
    const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({
      system_instruction: { parts: [{ text: systemPrompt }] },
      contents: [{ parts: contentsParts }],
      generationConfig: { temperature: 0.2, maxOutputTokens: 8192 }
    })});

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.error?.message || res.statusText);
    }
    const data = await res.json();
    const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
    
    if (!result) {
      throw new Error('çµæœãŒç©ºã§ã—ãŸ');
    }
    
    return result;
  }

  async function generateDoc() {
    if (!apiKey) { showToast('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error'); toggleSettings(); return; }
    const freeText = document.getElementById('inputText').value.trim();
    if (!freeText && currentImages.length === 0) { showToast('ãƒ†ã‚­ã‚¹ãƒˆã‹ç”»åƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning'); return; }

    const btn = document.getElementById('generateBtn');
    const out = document.getElementById('outputText');
    const status = document.getElementById('statusText');
    const continueBtn = document.getElementById('continueBtn');

    btn.disabled = true;
    const btnContent = btn.querySelector('#btnContent');
    if (btnContent) {
      btnContent.innerHTML = '<div class="spinner"></div><span>æ€è€ƒä¸­...</span>';
    } else {
      btn.innerHTML = '<div class="spinner"></div><span>æ€è€ƒä¸­...</span>';
    }
    continueBtn.style.display = 'none';
    status.textContent = `${currentModel} ã§åŸ·ç­†ä¸­...`;
    out.value = '';

    try {
      // ã‚µãƒãƒªãƒ¼ï¼†è©³è¨˜ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯é †ç•ªã«ç”Ÿæˆ
      if (currentMode === 'summary-shoki') {
        try {
          // ã¾ãšã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
          status.textContent = `${currentModel} ã§ã‚µãƒãƒªãƒ¼ç”Ÿæˆä¸­...`;
          const summaryResult = await generateSingleDoc('summary', freeText);
          
          // æ¬¡ã«è©³è¨˜ã‚’ç”Ÿæˆ
          status.textContent = `${currentModel} ã§è©³è¨˜ç”Ÿæˆä¸­...`;
          const shokiResult = await generateSingleDoc('shoki', freeText);
          
          // çµæœã‚’çµåˆ
          out.value = summaryResult + '\n\n' + '='.repeat(50) + '\n\n' + shokiResult;
          status.textContent = 'å®Œäº†ï¼ˆã‚µãƒãƒªãƒ¼ï¼†è©³è¨˜ï¼‰';
          continueBtn.style.display = 'none';
          out.scrollTop = out.scrollHeight;
          showToast('ã‚µãƒãƒªãƒ¼ï¼†è©³è¨˜ã®ç”Ÿæˆå®Œäº†ï¼', 'success');
        } catch (e) {
          // ã‚¨ãƒ©ãƒ¼ã¯å¤–å´ã®catchãƒ–ãƒ­ãƒƒã‚¯ã§å‡¦ç†ã•ã‚Œã‚‹
          throw e;
        }
        return;
      }
      
      // Prompt Construction
      let systemPrompt = "";
      if (currentMode === 'consult') {
        const tD = document.getElementById('targetDept').value || 'ã€‡ã€‡ç§‘';
        const p = document.getElementById('consultPurpose').value || '';
        const sD = document.getElementById('sourceDept').value || 'å½“ç§‘';
        const mN = document.getElementById('referrerName').value || 'æ‹…å½“åŒ»';
        
        // ä¾é ¼ç›®çš„ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š
        let purposeDescription = '';
        if (p === 'è»¢ç§‘ä¾é ¼') {
          purposeDescription = `ä»¥ä¸‹ã®æ‚£è€…ã‚’${tD}ã¸è»¢ç§‘ã®ã”ä¾é ¼ã‚’ã„ãŸã—ã¾ã™ã€‚`;
        } else if (p === 'ä½µè¨ºä¾é ¼') {
          purposeDescription = 'ä»¥ä¸‹ã®æ‚£è€…ã®ä½µè¨ºã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚';
        } else if (p === 'å°‚é–€è¨ºå¯ŸãŠã‚ˆã³å¾¡åŠ©è¨€ä¾é ¼') {
          purposeDescription = 'ä»¥ä¸‹ã®æ‚£è€…ã®å°‚é–€è¨ºå¯ŸãŠã‚ˆã³å¾¡åŠ©è¨€ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚';
        } else if (p === '#7000ç•ªç´¹ä»‹ä¾é ¼') {
          purposeDescription = `ä»–é™¢ã‹ã‚‰ã®ç´¹ä»‹æ‚£è€…ï¼ˆ#7000ç•ªï¼‰ã‚’${tD}ã«ã”ç´¹ä»‹ã„ãŸã—ã¾ã™ã€‚`;
        } else {
          purposeDescription = p ? `ä»¥ä¸‹ã®æ‚£è€…ã®${p}ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚` : 'ä»¥ä¸‹ã®æ‚£è€…ã®ã”è¨ºå¯Ÿã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚';
        }
        
        systemPrompt = `ã‚ãªãŸã¯ã‚³ãƒ³ã‚µãƒ«ãƒˆä¾é ¼å´ã®åŒ»å¸«ã§ã™ã€‚é™¢å†…ä¾é ¼ã¨ã¯ã„ãˆã€å„å°‚é–€ç§‘ã¸ã®ä¾é ¼ãªã®ã§ã€ä¸å¯§ã§ç¤¼å„€æ­£ã—ã„æ‰‹ç´™å½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚ã€ŒãŠç–²ã‚Œæ§˜ã§ã™ã€ãªã©ã®ãƒ•ãƒ©ãƒ³ã‚¯ãªè¡¨ç¾ã¯é¿ã‘ã€ã€ŒãŠå¿™ã—ã„ä¸­ã€æç¸®ã§ã™ãŒã€ã€Œã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€ãªã©ã®ä¸å¯§ãªè¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
${FORMAT_RULES}
${ANTI_HALLUCINATION_RULES}

ã€é‡è¦ã€‘æ–‡ä½“ã«ã¤ã„ã¦ï¼šã™ã¹ã¦ã€Œã§ã™ã¾ã™èª¿ã€ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ã€Œã§ã‚ã‚‹ã€ã€Œã ã£ãŸã€ãªã©ã®ã§ã‚ã‚‹èª¿ã¯ä½¿ç”¨ã›ãšã€ã€Œã§ã™ã€ã€Œã¾ã™ã€ã€Œã§ã—ãŸã€ãªã©ã®ã§ã™ã¾ã™èª¿ã§çµ±ä¸€ã—ã¦ãã ã•ã„ã€‚

ã€å›ºå®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‘å®›å…ˆ:${tD}, ä¾é ¼å…ƒ:${sD} ${mN}${p ? `, ä¾é ¼ç›®çš„:${p}` : ''}

ã€æ§‹æˆã€‘
${tD} å¾¡ä¾å²

ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚${sD}ã®${mN}ã§ã™ã€‚
ãŠå¿™ã—ã„ä¸­ã€æç¸®ã§ã™ãŒã€${purposeDescription}

ã€ä¾é ¼ç›®çš„ã€‘
${p || 'ç‰¹ã«æŒ‡å®šãªã—'}

ã€çµŒéãƒ»æ‰€è¦‹ã€‘
(å…¥åŠ›æƒ…å ±ã‹ã‚‰è¦ç´„ã€‚ä¸æ˜ãªæ•°å€¤ã¯ã€Œ(ä¸æ˜)ã€ã¨æ›¸ã‹ãšã€è‡ªç„¶ã«çœç•¥ã—ã¦æ–‡ç« åŒ–ã™ã‚‹ã“ã¨ã€‚ä¾é ¼ç›®çš„ï¼ˆ${p || 'ç‰¹ã«æŒ‡å®šãªã—'}ï¼‰ã«åˆã‚ã›ã¦é©åˆ‡ãªå†…å®¹ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚ä¸å¯§ã§å°‚é–€çš„ãªè¡¨ç¾ã‚’ç”¨ã„ã‚‹ã“ã¨ã€‚å¿…ãšã§ã™ã¾ã™èª¿ã§è¨˜è¿°ã™ã‚‹ã“ã¨)

ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚`;
      } else if (currentMode === 'letter') {
        const tH = document.getElementById('targetHospital').value || 'ã€‡ã€‡åŒ»ç™‚æ©Ÿé–¢';
        const lP = document.getElementById('letterPurpose').value || '';
        const sD = document.getElementById('sourceDept').value || 'å½“ç§‘';
        const mN = document.getElementById('referrerName').value || 'æ‹…å½“åŒ»';
        systemPrompt = `ã‚ãªãŸã¯ç´¹ä»‹å…ƒã®åŒ»å¸«ã§ã™ã€‚ç´¹ä»‹çŠ¶ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
${FORMAT_RULES}
${ANTI_HALLUCINATION_RULES}

ã€é‡è¦ã€‘æ–‡ä½“ã«ã¤ã„ã¦ï¼šã™ã¹ã¦ã€Œã§ã™ã¾ã™èª¿ã€ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ã€Œã§ã‚ã‚‹ã€ã€Œã ã£ãŸã€ãªã©ã®ã§ã‚ã‚‹èª¿ã¯ä½¿ç”¨ã›ãšã€ã€Œã§ã™ã€ã€Œã¾ã™ã€ã€Œã§ã—ãŸã€ãªã©ã®ã§ã™ã¾ã™èª¿ã§çµ±ä¸€ã—ã¦ãã ã•ã„ã€‚

ã€å›ºå®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‘å®›å…ˆ:${tH}, ç´¹ä»‹å…ƒ:${sD} ${mN}${lP ? `, ç´¹ä»‹ç›®çš„:${lP}` : ''}

ã€æ§‹æˆã€‘
[æ—¥ä»˜]
${tH} å¾¡æœºä¸‹

æ‹å•“ æ™‚ä¸‹ç›Šã€…ã”æ¸…ç¥¥ã®ã“ã¨ã¨ãŠæ…¶ã³ç”³ã—ä¸Šã’ã¾ã™ã€‚
å¹³ç´ ã‚ˆã‚Šå¤§å¤‰ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚

ã€ç´¹ä»‹ç›®çš„ã€‘
${lP ? `${lP}ã®ãŸã‚ã€ã”ç´¹ä»‹ç”³ã—ä¸Šã’ã¾ã™ã€‚` : 'ã”ç´¹ä»‹ç”³ã—ä¸Šã’ã¾ã™ã€‚'}

ã€çµŒéã€‘
(å…¥åŠ›æƒ…å ±ã‹ã‚‰æ™‚ç³»åˆ—ã§è¨˜è¿°ã€‚è©³ç´°ä¸æ˜ãªç‚¹ã¯ã€Œä¸æ˜ã€ã¨æ›¸ã‹ãšã€åˆ¤æ˜äº‹å®Ÿã®ã¿ã§æ§‹æˆã™ã‚‹ã“ã¨ã€‚ç´¹ä»‹ç›®çš„ï¼ˆ${lP || 'ç‰¹ã«æŒ‡å®šãªã—'}ï¼‰ã«åˆã‚ã›ã¦é©åˆ‡ãªå†…å®¹ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚å¿…ãšã§ã™ã¾ã™èª¿ã§è¨˜è¿°ã™ã‚‹ã“ã¨)

ã”é«˜è¨ºã®ç¨‹ã€ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

æ•¬å…·

[è‡ªé™¢å]
${sD} ${mN}`;
      } else {
        systemPrompt = getBasePrompt(currentMode);
      }

      // å…¥åŠ›å†…å®¹ã«å¿œã˜ãŸcontentsPartsæ§‹ç¯‰
      const contentsParts = [];
      const hasImages = currentImages.length > 0;
      const hasText = freeText.length > 0;

      if (hasImages) {
        currentImages.forEach(d => contentsParts.push({ inline_data: { mime_type: "image/jpeg", data: d } }));
      }

      const instruction = "è©³ç´°ãŒèª­ã¿å–ã‚Œãªã„æƒ…å ±ã¯æé€ ã›ãšã€ã¾ãŸã€Œä¸æ˜ã€ã¨ã‚‚æ›¸ã‹ãšã«ã€åˆ¤æ˜ã—ã¦ã„ã‚‹æƒ…å ±ã ã‘ã§è‡ªç„¶ãªæ–‡ç« ã«ã™ã‚‹ã“ã¨ã€‚ç·¨é›†ã®æ‰‹é–“ã‚’çœããŸã‚ã€ä¸æ˜ãªç®‡æ‰€ã®æ³¨é‡ˆã¯ä¸è¦ã€‚";

      if (hasImages && hasText) {
        contentsParts.push({ text: `ä»¥ä¸‹ã®ç”»åƒ(ã‚«ãƒ«ãƒ†ç­‰)ã¨ãƒ¡ãƒ¢ã‚’çµ±åˆã—ã¦ä½œæˆã›ã‚ˆã€‚${instruction}\n\nã€ãƒ¡ãƒ¢ã€‘\n${freeText}` });
      } else if (hasImages) {
        contentsParts.push({ text: `ä»¥ä¸‹ã®ç”»åƒ(ã‚«ãƒ«ãƒ†ç­‰)ã‚’è§£æã—ã¦ä½œæˆã›ã‚ˆã€‚${instruction}` });
      } else {
        contentsParts.push({ text: `ä»¥ä¸‹ã®ãƒ¡ãƒ¢ã‚’å…ƒã«ä½œæˆã›ã‚ˆã€‚${instruction}\n\nã€ãƒ¡ãƒ¢ã€‘\n${freeText}` });
      }

      lastContentsParts = contentsParts;

      const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;
      const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({
        system_instruction: { parts: [{ text: systemPrompt }] },
        contents: [{ parts: contentsParts }],
        generationConfig: { temperature: 0.2, maxOutputTokens: 8192 }
      })});

      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        throw new Error(errorData.error?.message || res.statusText);
      }
      const data = await res.json();
      const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (result) {
        out.value = result;
        status.textContent = 'å®Œäº†';
        continueBtn.style.display = 'flex';
        out.scrollTop = out.scrollHeight;
        showToast('ç”Ÿæˆå®Œäº†ï¼', 'success');
      } else { throw new Error('çµæœãŒç©ºã§ã—ãŸ'); }

    } catch (e) { 
      showToast(`ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error'); 
      status.textContent = 'ã‚¨ãƒ©ãƒ¼';
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯lastContentsPartsã‚’æ›´æ–°ã—ãªã„ï¼ˆå‰å›ã®çŠ¶æ…‹ã‚’ä¿æŒï¼‰
    } 
    finally { 
      btn.disabled = false;
      const btnContent = btn.querySelector('#btnContent');
      if (btnContent) {
        btnContent.textContent = 'âœ¨ ç”Ÿæˆé–‹å§‹';
      } else {
        btn.innerHTML = '<span id="btnContent">âœ¨ ç”Ÿæˆé–‹å§‹</span>';
      }
    }
  }

  async function generateContinue() {
    if (!lastContentsParts || lastContentsParts.length === 0) {
      showToast('ç¶šãã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€å…ˆã«æ–‡æ›¸ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    const btn = document.getElementById('continueBtn');
    const out = document.getElementById('outputText');
    if (!out.value || out.value.trim().length === 0) {
      showToast('ç¶šãã‚’ç”Ÿæˆã™ã‚‹ã«ã¯ã€å…ˆã«æ–‡æ›¸ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    const orgHTML = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = '<div class="spinner"></div><span>ç¶šã...</span>';
    try {
      // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸsystemPromptã‚’å–å¾—
      let systemPrompt = "";
      if (currentMode === 'consult') {
        const tD = document.getElementById('targetDept').value || 'ã€‡ã€‡ç§‘';
        const p = document.getElementById('consultPurpose').value || '';
        const sD = document.getElementById('sourceDept').value || 'å½“ç§‘';
        const mN = document.getElementById('referrerName').value || 'æ‹…å½“åŒ»';
        
        // ä¾é ¼ç›®çš„ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š
        let purposeDescription = '';
        if (p === 'è»¢ç§‘ä¾é ¼') {
          purposeDescription = `ä»¥ä¸‹ã®æ‚£è€…ã‚’${tD}ã¸è»¢ç§‘ã®ã”ä¾é ¼ã‚’ã„ãŸã—ã¾ã™ã€‚`;
        } else if (p === 'ä½µè¨ºä¾é ¼') {
          purposeDescription = 'ä»¥ä¸‹ã®æ‚£è€…ã®ä½µè¨ºã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚';
        } else if (p === 'å°‚é–€è¨ºå¯ŸãŠã‚ˆã³å¾¡åŠ©è¨€ä¾é ¼') {
          purposeDescription = 'ä»¥ä¸‹ã®æ‚£è€…ã®å°‚é–€è¨ºå¯ŸãŠã‚ˆã³å¾¡åŠ©è¨€ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚';
        } else if (p === '#7000ç•ªç´¹ä»‹ä¾é ¼') {
          purposeDescription = `ä»–é™¢ã‹ã‚‰ã®ç´¹ä»‹æ‚£è€…ï¼ˆ#7000ç•ªï¼‰ã‚’${tD}ã«ã”ç´¹ä»‹ã„ãŸã—ã¾ã™ã€‚`;
        } else {
          purposeDescription = p ? `ä»¥ä¸‹ã®æ‚£è€…ã®${p}ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚` : 'ä»¥ä¸‹ã®æ‚£è€…ã®ã”è¨ºå¯Ÿã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚';
        }
        
        systemPrompt = `ã‚ãªãŸã¯ã‚³ãƒ³ã‚µãƒ«ãƒˆä¾é ¼å´ã®åŒ»å¸«ã§ã™ã€‚é™¢å†…ä¾é ¼ã¨ã¯ã„ãˆã€å„å°‚é–€ç§‘ã¸ã®ä¾é ¼ãªã®ã§ã€ä¸å¯§ã§ç¤¼å„€æ­£ã—ã„æ‰‹ç´™å½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚ã€ŒãŠç–²ã‚Œæ§˜ã§ã™ã€ãªã©ã®ãƒ•ãƒ©ãƒ³ã‚¯ãªè¡¨ç¾ã¯é¿ã‘ã€ã€ŒãŠå¿™ã—ã„ä¸­ã€æç¸®ã§ã™ãŒã€ã€Œã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€ãªã©ã®ä¸å¯§ãªè¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
${FORMAT_RULES}
${ANTI_HALLUCINATION_RULES}

ã€é‡è¦ã€‘æ–‡ä½“ã«ã¤ã„ã¦ï¼šã™ã¹ã¦ã€Œã§ã™ã¾ã™èª¿ã€ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ã€Œã§ã‚ã‚‹ã€ã€Œã ã£ãŸã€ãªã©ã®ã§ã‚ã‚‹èª¿ã¯ä½¿ç”¨ã›ãšã€ã€Œã§ã™ã€ã€Œã¾ã™ã€ã€Œã§ã—ãŸã€ãªã©ã®ã§ã™ã¾ã™èª¿ã§çµ±ä¸€ã—ã¦ãã ã•ã„ã€‚

ã€å›ºå®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‘å®›å…ˆ:${tD}, ä¾é ¼å…ƒ:${sD} ${mN}${p ? `, ä¾é ¼ç›®çš„:${p}` : ''}

ã€æ§‹æˆã€‘
${tD} å¾¡ä¾å²

ã„ã¤ã‚‚ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚${sD}ã®${mN}ã§ã™ã€‚
ãŠå¿™ã—ã„ä¸­ã€æç¸®ã§ã™ãŒã€${purposeDescription}

ã€ä¾é ¼ç›®çš„ã€‘
${p || 'ç‰¹ã«æŒ‡å®šãªã—'}

ã€çµŒéãƒ»æ‰€è¦‹ã€‘
(å…¥åŠ›æƒ…å ±ã‹ã‚‰è¦ç´„ã€‚ä¸æ˜ãªæ•°å€¤ã¯ã€Œ(ä¸æ˜)ã€ã¨æ›¸ã‹ãšã€è‡ªç„¶ã«çœç•¥ã—ã¦æ–‡ç« åŒ–ã™ã‚‹ã“ã¨ã€‚ä¾é ¼ç›®çš„ï¼ˆ${p || 'ç‰¹ã«æŒ‡å®šãªã—'}ï¼‰ã«åˆã‚ã›ã¦é©åˆ‡ãªå†…å®¹ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚ä¸å¯§ã§å°‚é–€çš„ãªè¡¨ç¾ã‚’ç”¨ã„ã‚‹ã“ã¨ã€‚å¿…ãšã§ã™ã¾ã™èª¿ã§è¨˜è¿°ã™ã‚‹ã“ã¨)

ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚`;
      } else if (currentMode === 'letter') {
        const tH = document.getElementById('targetHospital').value || 'ã€‡ã€‡åŒ»ç™‚æ©Ÿé–¢';
        const lP = document.getElementById('letterPurpose').value || '';
        const sD = document.getElementById('sourceDept').value || 'å½“ç§‘';
        const mN = document.getElementById('referrerName').value || 'æ‹…å½“åŒ»';
        systemPrompt = `ã‚ãªãŸã¯ç´¹ä»‹å…ƒã®åŒ»å¸«ã§ã™ã€‚ç´¹ä»‹çŠ¶ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
${FORMAT_RULES}
${ANTI_HALLUCINATION_RULES}

ã€é‡è¦ã€‘æ–‡ä½“ã«ã¤ã„ã¦ï¼šã™ã¹ã¦ã€Œã§ã™ã¾ã™èª¿ã€ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ã€Œã§ã‚ã‚‹ã€ã€Œã ã£ãŸã€ãªã©ã®ã§ã‚ã‚‹èª¿ã¯ä½¿ç”¨ã›ãšã€ã€Œã§ã™ã€ã€Œã¾ã™ã€ã€Œã§ã—ãŸã€ãªã©ã®ã§ã™ã¾ã™èª¿ã§çµ±ä¸€ã—ã¦ãã ã•ã„ã€‚

ã€å›ºå®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‘å®›å…ˆ:${tH}, ç´¹ä»‹å…ƒ:${sD} ${mN}${lP ? `, ç´¹ä»‹ç›®çš„:${lP}` : ''}

ã€æ§‹æˆã€‘
[æ—¥ä»˜]
${tH} å¾¡æœºä¸‹

æ‹å•“ æ™‚ä¸‹ç›Šã€…ã”æ¸…ç¥¥ã®ã“ã¨ã¨ãŠæ…¶ã³ç”³ã—ä¸Šã’ã¾ã™ã€‚
å¹³ç´ ã‚ˆã‚Šå¤§å¤‰ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚

ã€ç´¹ä»‹ç›®çš„ã€‘
${lP ? `${lP}ã®ãŸã‚ã€ã”ç´¹ä»‹ç”³ã—ä¸Šã’ã¾ã™ã€‚` : 'ã”ç´¹ä»‹ç”³ã—ä¸Šã’ã¾ã™ã€‚'}

ã€çµŒéã€‘
(å…¥åŠ›æƒ…å ±ã‹ã‚‰æ™‚ç³»åˆ—ã§è¨˜è¿°ã€‚è©³ç´°ä¸æ˜ãªç‚¹ã¯ã€Œä¸æ˜ã€ã¨æ›¸ã‹ãšã€åˆ¤æ˜äº‹å®Ÿã®ã¿ã§æ§‹æˆã™ã‚‹ã“ã¨ã€‚ç´¹ä»‹ç›®çš„ï¼ˆ${lP || 'ç‰¹ã«æŒ‡å®šãªã—'}ï¼‰ã«åˆã‚ã›ã¦é©åˆ‡ãªå†…å®¹ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚å¿…ãšã§ã™ã¾ã™èª¿ã§è¨˜è¿°ã™ã‚‹ã“ã¨)

ã”é«˜è¨ºã®ç¨‹ã€ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

æ•¬å…·

[è‡ªé™¢å]
${sD} ${mN}`;
      } else {
        systemPrompt = getBasePrompt(currentMode);
      }

      const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;
      const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({
        system_instruction: { parts: [{ text: systemPrompt }] },
        contents: [
            { role: 'user', parts: lastContentsParts },
            { role: 'model', parts: [{ text: out.value }] },
            { role: 'user', parts: [{ text: "ç¶šãã‚’æ›¸ã„ã¦å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚å¼•ãç¶šãã€ä¸æ˜ãªç‚¹ã¯è‡ªç„¶ã«çœç•¥ã—ã€ã€Œä¸æ˜ã€ã¨ã¯æ›¸ã‹ãªã„ã“ã¨ã€‚" }] }
        ],
        generationConfig: { temperature: 0.2, maxOutputTokens: 8192 }
      })});

      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}));
        throw new Error(errorData.error?.message || res.statusText);
      }
      
      const data = await res.json();
      const added = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (added) { 
        out.value += added; 
        out.scrollTop = out.scrollHeight; 
        showToast('ç¶šãã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success'); 
      } else {
        throw new Error('ç¶šãã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch(e) { 
      showToast('å¤±æ•—: ' + e.message, 'error'); 
    } 
    finally { btn.disabled = false; btn.innerHTML = orgHTML; }
  }

  function setMode(mode) {
    currentMode = mode;
    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å‰å›ã®ç”ŸæˆçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    lastContentsParts = null;
    document.getElementById('continueBtn').style.display = 'none';
    document.getElementById('outputText').value = '';
    document.getElementById('statusText').textContent = '';
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    const tabId = mode === 'summary-shoki' ? 'tabSummaryShoki' : 'tab' + mode.charAt(0).toUpperCase() + mode.slice(1);
    document.getElementById(tabId).classList.add('active');
    
    document.getElementById('consultFields').style.display = (mode === 'consult') ? 'grid' : 'none';
    document.getElementById('letterFields').style.display = (mode === 'letter') ? 'grid' : 'none';
    document.getElementById('sourceFields').style.display = (mode === 'consult' || mode === 'letter') ? 'grid' : 'none';

    document.getElementById('modeHint').innerHTML = MODE_HINTS[mode].hint;
    document.getElementById('inputText').placeholder = MODE_HINTS[mode].placeholder;
  }
  
  function toggleSettings() {
    const s = document.getElementById('settingsArea').style;
    const o = document.getElementById('settingsOverlay').style;
    const isShow = s.display === 'block';
    s.display = o.display = isShow ? 'none' : 'block';
  }
  function saveApiKey() {
    const v = document.getElementById('apiKeyInput').value.trim();
    if(v) { localStorage.setItem('med_gen_api_key_v3', v); apiKey = v; showToast('APIã‚­ãƒ¼ä¿å­˜å®Œäº†', 'success'); }
  }
  function changeModel() {
    const s = document.getElementById('modelSelect');
    const c = document.getElementById('customModelInput');
    if(s.value==='custom'){ 
      c.style.display='block'; 
      currentModel=c.value.trim()||'gemini-2.5-pro'; 
    } else { 
      c.style.display='none'; 
      currentModel=s.value; 
    }
    localStorage.setItem('med_gen_model', currentModel); 
    updateBadge();
  }
  function updateBadge() {
    let n = currentModel.replace('gemini-', '').replace('flash', 'âš¡Flash').replace('pro', 'Pro');
    if(n.length>10) n='Custom'; document.getElementById('modelBadge').textContent = n;
  }
  function copyToClipboard() {
    const el = document.getElementById("outputText");
    if(!el.value || el.value.trim().length === 0) { 
      showToast('ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', 'warning'); 
      return; 
    }
    // Clipboard APIã‚’ä½¿ç”¨ï¼ˆreadonly textareaã§ã‚‚å‹•ä½œï¼‰
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(el.value)
        .then(() => showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'))
        .catch(() => {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤ã„æ–¹æ³•ã‚’è©¦ã™
          try {
            el.select();
            el.setSelectionRange(0, 99999);
            document.execCommand('copy');
            showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
          } catch (err) {
            showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        });
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ
      try {
        el.select();
        el.setSelectionRange(0, 99999);
        document.execCommand('copy');
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
      } catch (err) {
        showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }
  }
</script>
</body>
</html>
