<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<meta name="description" content="AI Medical Document Generator v4.3">
<meta name="theme-color" content="#005088">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Med-Doc">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<link rel="manifest" href="manifest.json">

<title>Med-Doc Gen v4.3 (Consult Master)</title>
<style>
  /* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
  :root {
    --primary: #005088;
    --primary-dark: #003f6b;
    --accent: #d35400;
    --bg: #f2f4f8;
    --surface: #ffffff;
    --text: #1a1a1a;
    --border: #ced4da;
    --sa-top: env(safe-area-inset-top, 20px);
    --sa-bottom: env(safe-area-inset-bottom, 20px);
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    margin: 0; padding: 0;
    background-color: var(--bg); color: var(--text);
    font-family: "Hiragino Sans", "Hiragino Kaku Gothic ProN", -apple-system, BlinkMacSystemFont, sans-serif;
    padding-top: calc(var(--sa-top) + 10px);
    padding-bottom: calc(var(--sa-bottom) + 30px);
    font-size: 15px;
    overscroll-behavior-y: none; 
  }
  .container {
    width: 100%; max-width: 600px; margin: 0 auto; padding: 0 16px;
    display: flex; flex-direction: column; gap: 16px;
  }

  /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
  header { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
  h1 { font-size: 18px; font-weight: 800; color: var(--primary); margin: 0; display: flex; align-items: center; gap: 8px; }
  .badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: 700; background: #e3f2fd; color: #0277bd; border: 1px solid #b3e5fc; }
  button.btn-settings { font-size: 22px; background: none; border: none; padding: 4px; cursor: pointer; opacity: 0.6; }

  /* --- è¨­å®šã‚¨ãƒªã‚¢ --- */
  #settingsOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; }
  #settingsArea {
    background: #fff; border: 1px solid var(--border); padding: 20px; 
    border-radius: 12px; display: none; flex-direction: column; gap: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1); z-index: 100;
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 90%; max-width: 400px;
  }
  .setting-group { display: flex; flex-direction: column; gap: 6px; }
  .setting-label { font-size: 13px; font-weight: 700; color: #444; }
  .setting-input { padding: 12px; border: 1px solid #bbb; border-radius: 8px; font-size: 15px; background: #f9f9f9; }
  select.setting-input { background-color: #fff; }

  /* --- ã‚¿ãƒ– --- */
  .tabs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; background: #e9ecef; padding: 6px; border-radius: 12px; }
  .tab {
    padding: 10px; font-size: 13px; font-weight: 700; 
    border-radius: 8px; border: none; background: transparent; 
    color: #6c757d; transition: all 0.2s; cursor: pointer;
  }
  .tab.active { background: #fff; color: var(--primary); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }

  /* --- ã‚«ãƒ¼ãƒ‰ --- */
  .card {
    background: var(--surface); border-radius: 12px; padding: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 12px;
  }
  .label-row { display: flex; justify-content: space-between; align-items: center; }
  label { font-weight: 700; font-size: 13px; color: #555; display: flex; align-items: center; gap: 6px; }

  /* --- å›ºå®šå…¥åŠ›æ  (Consult/Letterç”¨) --- */
  .field-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º */ }
  .field-full { grid-column: 1 / -1; }
  .input-field {
    width: 100%; padding: 10px; border: 1px solid #bbb; border-radius: 8px;
    font-size: 14px; background: #fdfdfd;
  }
  .input-field:focus { border-color: var(--primary); outline: none; background: #fff; }
  .field-label { font-size: 11px; font-weight: bold; color: #666; margin-bottom: 4px; display: block; }

  /* --- ã‚«ãƒ¡ãƒ© --- */
  .btn-camera {
    width: 100%; padding: 14px; 
    border: 2px dashed #aab7c4; border-radius: 10px;
    background: #f8fbff; color: var(--primary); 
    font-size: 14px; font-weight: 700;
    display: flex; justify-content: center; align-items: center; gap: 8px;
    cursor: pointer;
  }
  .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px; }
  .thumb-container { position: relative; width: 100%; padding-top: 100%; border-radius: 8px; overflow: hidden; background: #eee; }
  .thumb-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
  .btn-remove-thumb {
    position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: #fff; border: none;
    border-radius: 50%; width: 20px; height: 20px; font-size: 12px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }

  /* --- ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ --- */
  textarea {
    width: 100%; border: 1px solid var(--border); border-radius: 10px; padding: 12px;
    font-size: 16px; line-height: 1.6; resize: none; background: #fff;
    font-family: inherit; -webkit-appearance: none;
  }
  textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }
  #inputText { min-height: 100px; }
  #outputText { min-height: 350px; background: #fcfcfc; border-color: #d1d9e6; color: #212529; font-family: "Hiragino Sans", sans-serif; }

  /* --- ãƒœã‚¿ãƒ³ --- */
  .btn-main {
    width: 100%; padding: 16px; border: none; border-radius: 10px;
    font-size: 16px; font-weight: 700; cursor: pointer;
    display: flex; justify-content: center; align-items: center; gap: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: opacity 0.2s;
  }
  .btn-main:active { opacity: 0.8; }
  .btn-generate { background: var(--primary); color: #fff; }
  .btn-generate:disabled { background: #95a5a6; }
  .btn-clear-imgs { font-size:12px; color:#c0392b; background:none; border:none; text-decoration:underline; cursor:pointer; }
  .btn-continue { background: #f39c12; color: #fff; margin-top: 10px; display: none; }
  .btn-copy { background: #27ae60; color: #fff; margin-top: 10px; }
  .hint { font-size: 12px; color: #666; background: #eef2f5; padding: 8px 12px; border-radius: 6px; line-height: 1.4; }
  #cameraInput { display: none; }
</style>
</head>
<body>

<div class="container">
  
  <header>
    <h1>Med-Doc <span style="font-size:0.8em; opacity:0.6;">Pro</span>
      <span class="badge" id="modelBadge">Loading...</span>
    </h1>
    <button class="btn-settings" onclick="toggleSettings()">âš™ï¸</button>
  </header>

  <div id="settingsOverlay" onclick="toggleSettings()"></div>
  <div id="settingsArea">
    <div style="text-align:center; font-weight:bold; margin-bottom:10px;">è¨­å®š</div>
    <div class="setting-group">
      <div class="setting-label">Gemini API Key</div>
      <input type="password" id="apiKeyInput" class="setting-input" placeholder="AIzaSy..." onchange="saveApiKey()">
    </div>
    <div class="setting-group">
      <div class="setting-label">ä½¿ç”¨AIãƒ¢ãƒ‡ãƒ«</div>
      <select id="modelSelect" class="setting-input" onchange="changeModel()">
        <option value="gemini-2.5-pro">Gemini 2.5 Pro (â˜…æ¨å¥¨)</option>
        <option value="gemini-2.5-flash">Gemini 2.5 Flash (é«˜é€Ÿ)</option>
        <option value="custom">ã‚«ã‚¹ã‚¿ãƒ ...</option>
      </select>
      <input type="text" id="customModelInput" class="setting-input" style="display:none; margin-top:6px;" placeholder="gemini-experimental">
    </div>
    <div style="text-align:right; margin-top:10px;">
      <button onclick="toggleSettings()" style="padding:10px 20px; border:none; background:var(--primary); color:#fff; border-radius:6px; font-weight:bold;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="setMode('summary')" id="tabSummary">é€€é™¢ã‚µãƒãƒªãƒ¼</button>
    <button class="tab" onclick="setMode('shoki')" id="tabShoki">ç—‡çŠ¶è©³è¨˜</button>
    <button class="tab" onclick="setMode('letter')" id="tabLetter">ç´¹ä»‹çŠ¶</button>
    <button class="tab" onclick="setMode('consult')" id="tabConsult">ã‚³ãƒ³ã‚µãƒ«ãƒˆ</button>
  </div>

  <div class="card">
    
    <div id="consultFields" class="field-grid">
      <div>
        <span class="field-label">å®›å…ˆè¨ºç™‚ç§‘</span>
        <input type="text" id="targetDept" class="input-field" placeholder="ä¾‹: å¾ªç’°å™¨å†…ç§‘">
      </div>
      <div>
        <span class="field-label">ä¾é ¼ç›®çš„</span>
        <input type="text" id="consultPurpose" class="input-field" placeholder="ä¾‹: å† å‹•è„ˆç²¾æŸ»">
      </div>
    </div>

    <div id="sourceFields" class="field-grid" style="margin-top:0;">
      <div>
        <span class="field-label">ç´¹ä»‹å…ƒ(è‡ªç§‘) â€»ä¿å­˜</span>
        <input type="text" id="sourceDept" class="input-field" placeholder="ä¾‹: æ•‘æ€¥ç§‘" onchange="saveProfile()">
      </div>
      <div>
        <span class="field-label">ç´¹ä»‹è€…(è‡ªåˆ†) â€»ä¿å­˜</span>
        <input type="text" id="referrerName" class="input-field" placeholder="ä¾‹: æ•‘æ€¥å¤ªéƒ" onchange="saveProfile()">
      </div>
    </div>
    
    <hr style="width:100%; border:0; border-top:1px dashed #ddd; margin:12px 0;">

    <div class="label-row">
       <div class="btn-camera" onclick="document.getElementById('cameraInput').click()">
         <span>ğŸ“· çµŒé/ç”»åƒ (è¤‡æ•°å¯)</span>
       </div>
       <button class="btn-clear-imgs" onclick="clearImages()">å…¨å‰Šé™¤</button>
    </div>
    <input type="file" id="cameraInput" accept="image/*" multiple onchange="handleImageSelect(this)">

    <div class="image-grid" id="imageGrid"></div>

    <div class="hint" id="modeHint"></div>
    <textarea id="inputText"></textarea>

    <button class="btn-main btn-generate" id="generateBtn" onclick="generateDoc()">
      <span>âœ¨ ç”Ÿæˆé–‹å§‹</span>
    </button>
  </div>

  <div class="card">
    <div class="label-row">
      <label>iNoteè²¼ä»˜ç”¨</label>
      <span style="font-size:10px; color:#999;" id="statusText"></span>
    </div>
    <textarea id="outputText" readonly placeholder="ã“ã“ã«ç”ŸæˆçµæœãŒå‡ºã¾ã™"></textarea>
    
    <button class="btn-main btn-continue" id="continueBtn" onclick="generateContinue()">
      ğŸ”„ ç¶šãã‚’æ›¸ã
    </button>
    <button class="btn-main btn-copy" onclick="copyToClipboard()">
      ğŸ“‹ ã‚³ãƒ”ãƒ¼ (iNoteã¸)
    </button>
  </div>
  
  <div style="text-align:center; font-size:10px; color:#aaa; margin-top:20px;">
    Med-Doc Gen v4.3 - Consult & Profile Memory
  </div>

</div>

<script>
  /* --- Global State --- */
  let currentMode = 'summary';
  let apiKey = localStorage.getItem('med_gen_api_key_v3') || '';
  let currentModel = localStorage.getItem('med_gen_model') || 'gemini-2.5-pro'; 
  let currentImages = [];
  let lastContentsParts = null;

  /* --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®šç¾© --- */
  const FORMAT_RULES = `
ã€å‡ºåŠ›å½¢å¼ã®å³å®ˆäº‹é …ã€‘
1. é›»å­ã‚«ãƒ«ãƒ†(iNote)è²¼ä»˜ç”¨ã€‚Markdownè¨˜æ³•ã¯ç¦æ­¢ã€‚
2. è¦‹å‡ºã—ã¯ã€ ã€‘ï¼ˆéš…ä»˜ãæ‹¬å¼§ï¼‰ã§å›²ã‚€ã€‚
3. æ–‡ä½“ã¯å°‚é–€åŒ»ã¨ã—ã¦é©åˆ‡ã«ã€‚
`;

  /* --- åˆæœŸåŒ– --- */
  window.onload = () => {
    // API Key
    document.getElementById('apiKeyInput').value = apiKey;
    
    // Model Selection
    const select = document.getElementById('modelSelect');
    if (![...select.options].some(o => o.value === currentModel)) {
       select.value = 'custom';
       document.getElementById('customModelInput').style.display = 'block';
       document.getElementById('customModelInput').value = currentModel;
    } else {
       select.value = currentModel;
    }
    updateBadge();

    // Profile Loading (è‡ªç§‘ãƒ»æ°åã®å¾©å…ƒ)
    document.getElementById('sourceDept').value = localStorage.getItem('med_doc_source_dept') || '';
    document.getElementById('referrerName').value = localStorage.getItem('med_doc_referrer_name') || '';

    // Initial Mode
    if (!apiKey) {
      document.getElementById('settingsOverlay').style.display = 'block';
      document.getElementById('settingsArea').style.display = 'block';
    }
    setMode('summary');
  };

  /* --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜ --- */
  function saveProfile() {
    const dept = document.getElementById('sourceDept').value;
    const name = document.getElementById('referrerName').value;
    localStorage.setItem('med_doc_source_dept', dept);
    localStorage.setItem('med_doc_referrer_name', name);
  }

  /* --- ç”»åƒå‡¦ç† --- */
  async function handleImageSelect(input) {
    if (input.files && input.files.length > 0) {
      const files = Array.from(input.files);
      for (let file of files) await processAndAddImage(file);
      input.value = ''; 
    }
  }
  function processAndAddImage(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          const max = 1500;
          if (w > h && w > max) { h *= max/w; w = max; }
          else if (h > max) { w *= max/h; h = max; }
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          currentImages.push(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
          renderImageGrid();
          resolve();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  }
  function renderImageGrid() {
    const grid = document.getElementById('imageGrid');
    grid.innerHTML = '';
    currentImages.forEach((imgBase64, index) => {
      const container = document.createElement('div');
      container.className = 'thumb-container';
      const img = document.createElement('img');
      img.src = 'data:image/jpeg;base64,' + imgBase64;
      img.className = 'thumb-img';
      const btn = document.createElement('button');
      btn.className = 'btn-remove-thumb';
      btn.innerHTML = 'Ã—';
      btn.onclick = () => { currentImages.splice(index, 1); renderImageGrid(); };
      container.appendChild(img);
      container.appendChild(btn);
      grid.appendChild(container);
    });
  }
  function clearImages() { currentImages = []; renderImageGrid(); }

  /* --- ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ --- */
  async function generateDoc() {
    if (!apiKey) { alert('è¨­å®šã‹ã‚‰APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); toggleSettings(); return; }
    
    // å…¥åŠ›æƒ…å ±ã®å–å¾—
    const freeText = document.getElementById('inputText').value.trim();
    
    // å›ºå®šæ æƒ…å ±ã®å–å¾—
    const targetDept = document.getElementById('targetDept').value.trim() || 'ã€‡ã€‡ç§‘';
    const purpose = document.getElementById('consultPurpose').value.trim() || 'ç²¾æŸ»åŠ ç™‚';
    const sourceDept = document.getElementById('sourceDept').value.trim() || 'å½“ç§‘';
    const myName = document.getElementById('referrerName').value.trim() || 'æ‹…å½“åŒ»';

    if (!freeText && currentImages.length === 0) { alert('ãƒ†ã‚­ã‚¹ãƒˆã‹ç”»åƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    const btn = document.getElementById('generateBtn');
    const out = document.getElementById('outputText');
    const status = document.getElementById('statusText');
    const continueBtn = document.getElementById('continueBtn');
    
    btn.disabled = true; btn.textContent = 'æ€è€ƒä¸­...';
    continueBtn.style.display = 'none';
    status.textContent = `${currentModel} ã§åŸ·ç­†ä¸­...`;
    out.value = '';

    try {
      // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆå›ºå®šæ ã®å€¤ã‚’åŸ‹ã‚è¾¼ã‚€ï¼‰
      let systemPrompt = "";
      
      if (currentMode === 'consult') {
        systemPrompt = `ã‚ãªãŸã¯ã‚³ãƒ³ã‚µãƒ«ãƒˆä¾é ¼å´ã®åŒ»å¸«ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã§å¯¾è¨ºä¾é ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
${FORMAT_RULES}
ã€å›ºå®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‘
ãƒ»å®›å…ˆ: ${targetDept}
ãƒ»ä¾é ¼å…ƒ: ${sourceDept} ${myName}åŒ»å¸«
ãƒ»ç›®çš„: ${purpose}

ã€æ§‹æˆã€‘
${targetDept} å¾¡ä¾å²
ãŠç–²ã‚Œæ§˜ã§ã™ã€‚${sourceDept}ã®${myName}ã§ã™ã€‚
ä»¥ä¸‹ã®æ‚£è€…ã®${purpose}ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

ã€ä¾é ¼ç›®çš„ã€‘
${purpose}

ã€çµŒéãƒ»æ‰€è¦‹ã€‘
(å…¥åŠ›ã•ã‚ŒãŸç”»åƒ/ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰è¦ç´„)

ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;

      } else if (currentMode === 'letter') {
        systemPrompt = `ã‚ãªãŸã¯ç´¹ä»‹å…ƒã®åŒ»å¸«ã§ã™ã€‚ç´¹ä»‹çŠ¶ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
${FORMAT_RULES}
ã€å›ºå®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‘
ãƒ»ç´¹ä»‹å…ƒ: ${sourceDept} ${myName}åŒ»å¸«

ã€æ§‹æˆã€‘
[æ—¥ä»˜] [ç›¸æ‰‹å…ˆåŒ»ç™‚æ©Ÿé–¢] å¾¡æœºä¸‹
[è‡ªé™¢å] ${sourceDept} ${myName} å°

(å®šå‹æŒ¨æ‹¶)
ã€ç´¹ä»‹ç›®çš„ã€‘
ã€çµŒéã€‘
(å…¥åŠ›æƒ…å ±ã‹ã‚‰æ™‚ç³»åˆ—è¨˜è¿°)
(çµã³)`;
      } else {
        // Summary, Shoki (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯)
        systemPrompt = getBasePrompt(currentMode);
      }

      const contentsParts = [];
      if (currentImages.length > 0) {
        currentImages.forEach(d => contentsParts.push({ inline_data: { mime_type: "image/jpeg", data: d } }));
        contentsParts.push({ text: `ç”»åƒ(ã‚«ãƒ«ãƒ†)ã¨ä»¥ä¸‹ã®ãƒ¡ãƒ¢ã‚’çµ±åˆã—ã¦ä½œæˆã›ã‚ˆ:\n${freeText}` });
      } else {
        contentsParts.push({ text: freeText });
      }

      lastContentsParts = contentsParts;

      const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;
      const payload = {
        system_instruction: { parts: [{ text: systemPrompt }] },
        contents: [{ parts: contentsParts }],
        generationConfig: { temperature: 0.2, maxOutputTokens: 8192 }
      };

      const res = await fetch(url, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error((await res.json()).error?.message || res.statusText);
      const data = await res.json();
      const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (result) {
        out.value = result;
        status.textContent = 'å®Œäº†';
        continueBtn.style.display = 'flex';
      } else { throw new Error('çµæœãŒç©ºã§ã—ãŸ'); }

    } catch (e) { alert(`ã‚¨ãƒ©ãƒ¼: ${e.message}`); status.textContent = 'ã‚¨ãƒ©ãƒ¼'; } 
    finally { btn.disabled = false; btn.textContent = 'âœ¨ ç”Ÿæˆé–‹å§‹'; }
  }

  /* --- ç¶šãç”Ÿæˆ --- */
  async function generateContinue() {
    if (!lastContentsParts) return;
    const btn = document.getElementById('continueBtn');
    const out = document.getElementById('outputText');
    btn.disabled = true; btn.textContent = 'ç¶šã...';
    try {
      // ç¶™ç¶šæ™‚ã¯ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å†åˆ©ç”¨ã—ãŸã„ãŒã€ç°¡æ˜“çš„ã«ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨
      // (å³å¯†ã«ã¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç¶­æŒã•ã‚Œã‚‹ã®ã§Instructionå†é€ã¯å†—é•·ã ãŒå¿µã®ãŸã‚)
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;
      const payload = {
        contents: [
            { role: 'user', parts: lastContentsParts },
            { role: 'model', parts: [{ text: out.value }] },
            { role: 'user', parts: [{ text: "ç¶šãã‚’æ›¸ã„ã¦å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚" }] }
        ],
        generationConfig: { temperature: 0.2, maxOutputTokens: 8192 }
      };
      const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await res.json();
      const added = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (added) out.value += added;
    } catch(e) { alert('å¤±æ•—: ' + e.message); }
    finally { btn.disabled = false; btn.textContent = 'ğŸ”„ ç¶šãã‚’æ›¸ã'; }
  }

  /* --- UI Helpers --- */
  function setMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    if(mode === 'summary') document.getElementById('tabSummary').classList.add('active');
    if(mode === 'shoki') document.getElementById('tabShoki').classList.add('active');
    if(mode === 'letter') document.getElementById('tabLetter').classList.add('active');
    if(mode === 'consult') document.getElementById('tabConsult').classList.add('active');
    
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºåˆ¶å¾¡
    const consultFields = document.getElementById('consultFields');
    const sourceFields = document.getElementById('sourceFields');
    
    if (mode === 'consult') {
        consultFields.style.display = 'grid'; // å®›å…ˆãƒ»ç›®çš„
        sourceFields.style.display = 'grid';  // è‡ªåˆ†
        document.getElementById('inputText').placeholder = "è£œè¶³ãƒ¡ãƒ¢: ç”»åƒã®ã“ã“ã‚’è¦‹ã¦ã»ã—ã„ã€ãªã©";
    } else if (mode === 'letter') {
        consultFields.style.display = 'none';
        sourceFields.style.display = 'grid';  // è‡ªåˆ†æƒ…å ±ã¯ç´¹ä»‹çŠ¶ã§ã‚‚ä½¿ã†
        document.getElementById('inputText').placeholder = "å®›å…ˆåŒ»ç™‚æ©Ÿé–¢åã€ã“ã‚Œã¾ã§ã®çµŒéãªã©";
    } else {
        consultFields.style.display = 'none';
        sourceFields.style.display = 'none';  // ã‚µãƒãƒªãƒ¼ãƒ»è©³è¨˜ã§ã¯ä¸è¦
        document.getElementById('inputText').placeholder = "è£œè¶³ãƒ¡ãƒ¢ (ä¾‹: ãƒã‚¤ã‚¿ãƒ«ä¸å®‰å®šã€â—â—æ‰‹æŠ€ã®å¿…è¦æ€§ã‚’å¼·èª¿ã—ã¦)";
    }
  }

  function getBasePrompt(mode) {
    if (mode === 'summary') {
        return `ã‚ãªãŸã¯æŒ‡å°åŒ»ã§ã™ã€‚J-OSLER/JHIMæº–æ‹ ã®é€€é™¢ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚${FORMAT_RULES}ã€æ§‹æˆã€‘å…¥é™¢ç—…å,å…¥é™¢å¾ŒçµŒé(ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ åˆ¥è©•ä¾¡ãƒ»æ²»ç™‚ãƒ»åå¿œ),è»¢å¸°,é€€é™¢æ–¹é‡ã€‚ãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³å³ç¦ã€‚`;
    }
    if (mode === 'shoki') {
        return `ã‚ãªãŸã¯ä¿é™ºåŒ»ã§ã™ã€‚æ•‘å‘½æ•‘æ€¥å…¥é™¢æ–™ã‚„é«˜é¡å‡¦ç½®ã®åŒ»å­¦çš„å¿…è¦æ€§ã‚’ä¸»å¼µã™ã‚‹ç—‡çŠ¶è©³è¨˜ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚${FORMAT_RULES}ã€æ§‹æˆã€‘å‚·ç—…å,è‡¨åºŠçµŒé(é‡ç—‡åº¦æŒ‡æ¨™GCS/SpO2ç­‰ã‚’å«ã‚€),åŒ»å­¦çš„æ ¹æ‹ ,çµè«–ã€‚`;
    }
    return "";
  }

  function toggleSettings() {
    const overlay = document.getElementById('settingsOverlay');
    const area = document.getElementById('settingsArea');
    const isShow = area.style.display === 'block';
    overlay.style.display = isShow ? 'none' : 'block';
    area.style.display = isShow ? 'none' : 'block';
  }
  
  function saveApiKey() {
    const val = document.getElementById('apiKeyInput').value.trim();
    if(val) { localStorage.setItem('med_gen_api_key_v3', val); apiKey = val; }
  }

  function changeModel() {
    const select = document.getElementById('modelSelect');
    const customInput = document.getElementById('customModelInput');
    if (select.value === 'custom') {
        customInput.style.display = 'block';
        currentModel = customInput.value.trim() || 'gemini-2.5-pro';
    } else {
        customInput.style.display = 'none';
        currentModel = select.value;
    }
    localStorage.setItem('med_gen_model', currentModel);
    updateBadge();
  }
  document.getElementById('customModelInput').addEventListener('change', function() {
      currentModel = this.value.trim(); localStorage.setItem('med_gen_model', currentModel); updateBadge();
  });
  function updateBadge() {
    let name = currentModel.replace('gemini-', '').replace('flash', 'âš¡Flash').replace('pro', 'Pro');
    if(name.length > 10) name = 'Custom';
    document.getElementById('modelBadge').textContent = name;
  }
  function copyToClipboard() {
    const el = document.getElementById("outputText");
    if(!el.value) return;
    el.select(); el.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(el.value).then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")).catch(e => alert("ã‚³ãƒ”ãƒ¼å¤±æ•—"));
  }
</script>
<script>
  // PWA Service Worker Registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('SW registered!', reg))
        .catch(err => console.log('SW failed', err));
    });
  }
</script>
</body>
</html>